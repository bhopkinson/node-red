[{"id":"98e70926.543948","type":"tab","label":"Home Assistant","disabled":false,"info":""},{"id":"8f5573e3.e52df","type":"subflow","name":"AutoRemote","info":"","category":"","in":[{"x":48,"y":62,"wires":[{"id":"85c3663c.2deeb8"}]}],"out":[{"x":978,"y":56,"wires":[{"id":"36f8aac7.5a44f6","port":0}]}]},{"id":"5806b60f.c2e778","type":"server","z":"","name":"Home Assistant","legacy":false,"hassio":false,"rejectUnauthorizedCerts":true,"ha_boolean":"y|yes|true|on|home|open"},{"id":"b7b614a.22dc4e8","type":"server-state-changed","z":"98e70926.543948","name":"Travis CI passed","server":"5806b60f.c2e778","entityidfilter":"sensor.bhopkinsonhomeassistantconfig_state","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"","halt_if_type":"str","halt_if_compare":"does_not_include","outputs":1,"x":141.5,"y":82,"wires":[["91f6432.8213ac"]]},{"id":"40dd2347.4b006c","type":"http request","z":"98e70926.543948","name":"Pull Config","method":"GET","ret":"txt","url":"http://192.168.0.10:9002/hooks/pull-hass-config","tls":"","x":174.5,"y":335,"wires":[["eb76813a.49e35"]]},{"id":"d509ac6b.473d9","type":"api-call-service","z":"98e70926.543948","name":"Restart","server":"5806b60f.c2e778","service_domain":"homeassistant","service":"restart","data":"","render_data":false,"mergecontext":"","output_location":"payload","output_location_type":"msg","x":477.5,"y":335,"wires":[[]]},{"id":"85c3663c.2deeb8","type":"switch","z":"8f5573e3.e52df","name":"device switch","property":"payload.autoremote.devices","propertyType":"msg","rules":[{"t":"cont","v":"all","vt":"str"},{"t":"cont","v":"brad","vt":"str"},{"t":"cont","v":"heather","vt":"str"}],"checkall":"true","repair":false,"outputs":3,"x":177.5,"y":61,"wires":[["7ee9425f.eebbbc","a77e02d4.b4c08"],["a77e02d4.b4c08"],["7ee9425f.eebbbc"]]},{"id":"36f8aac7.5a44f6","type":"http request","z":"8f5573e3.e52df","name":"","method":"GET","ret":"txt","url":"https://autoremotejoaomgcd.appspot.com/sendnotification?{{{payload}}}","tls":"","x":849.5,"y":56,"wires":[[]]},{"id":"93abf424.a7e898","type":"inject","z":"98e70926.543948","name":"","topic":"","payload":"created","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":168.5,"y":138,"wires":[["91f6432.8213ac"]]},{"id":"85b090f8.a53eb","type":"change","z":"98e70926.543948","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\"title\":\"test\",\"text\":\"test\",\"devices\":[\"brad\",\"heather\",\"all\"]}","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":321.5,"y":401,"wires":[["613cc96a.2501b8"]]},{"id":"ab669dc4.44ee8","type":"delay","z":"8f5573e3.e52df","name":"","pauseType":"timed","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":true,"x":299,"y":245,"wires":[["a00146e.1235fb8"]]},{"id":"a00146e.1235fb8","type":"credentials","z":"8f5573e3.e52df","name":"Set AutoRemote Credentials for Brad","props":[{"value":"payload.autoremote.key","type":"msg"},{"value":"payload.autoremote.password","type":"msg"}],"x":552,"y":244,"wires":[["445fc02a.6940c"]]},{"id":"e0247ece.0def8","type":"credentials","z":"8f5573e3.e52df","name":"Set AutoRemote Credentials for Heather","props":[{"value":"payload.autoremote.key","type":"msg"},{"value":"payload.autoremote.password","type":"msg"}],"x":561,"y":289,"wires":[["86992644.128088"]]},{"id":"f29cbe54.442f4","type":"delay","z":"8f5573e3.e52df","name":"","pauseType":"timed","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":true,"x":300,"y":289,"wires":[["e0247ece.0def8"]]},{"id":"6b2e6565.b9f81c","type":"actionflows_in","z":"8f5573e3.e52df","name":"brad in","priority":"50","links":[],"scope":"private","x":79.5,"y":246,"wires":[["ab669dc4.44ee8"]]},{"id":"445fc02a.6940c","type":"actionflows_out","z":"8f5573e3.e52df","name":"brad out","links":[],"x":818.5,"y":245,"wires":[]},{"id":"d78bf183.0a291","type":"actionflows_in","z":"8f5573e3.e52df","name":"heather in","priority":"50","links":[],"scope":"private","x":89.5,"y":289,"wires":[["f29cbe54.442f4"]]},{"id":"86992644.128088","type":"actionflows_out","z":"8f5573e3.e52df","name":"heather out","links":[],"x":811.5,"y":291,"wires":[]},{"id":"7ee9425f.eebbbc","type":"actionflows","z":"8f5573e3.e52df","info":"Describe your action API here.","untilproptype":"num","proptype":"msg","name":"heather","prop":"loop","untilprop":0,"until":"gt","loop":"none","scope":"private","perf":false,"seq":false,"x":383.5,"y":86,"wires":[["6d8cfe.b1d35304"]]},{"id":"a77e02d4.b4c08","type":"actionflows","z":"8f5573e3.e52df","info":"Describe your action API here.","untilproptype":"num","proptype":"msg","name":"brad","prop":"loop","untilprop":0,"until":"gt","loop":"none","scope":"private","perf":false,"seq":false,"x":383.5,"y":32,"wires":[["6d8cfe.b1d35304"]]},{"id":"613cc96a.2501b8","type":"subflow:8f5573e3.e52df","z":"98e70926.543948","name":"","x":520.5,"y":399,"wires":[[]]},{"id":"d8adbd1e.cdcf8","type":"debug","z":"98e70926.543948","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":1031.5,"y":195,"wires":[]},{"id":"eb76813a.49e35","type":"switch","z":"98e70926.543948","name":"OK?","property":"statusCode","propertyType":"msg","rules":[{"t":"eq","v":"200","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":326.5,"y":335,"wires":[["d509ac6b.473d9"]]},{"id":"91f6432.8213ac","type":"switch","z":"98e70926.543948","name":"","property":"payload","propertyType":"msg","rules":[{"t":"cont","v":"created","vt":"str"},{"t":"cont","v":"started","vt":"str"},{"t":"cont","v":"passed","vt":"str"}],"checkall":"false","repair":false,"outputs":3,"x":308.5,"y":82,"wires":[["4932781a.217888"],["6593da06.13ca84"],["df7f8877.52b368"]]},{"id":"c5ffb365.09e9b","type":"change","z":"98e70926.543948","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\t  \"title\":\"Orchard House\",\t  \"text\":\"Home assistant config check started\",\t  \"indeterminateProgress\":true,\t  \"action1\":\"cancelrestart token=:=\" & flow.notificationId,\t  \"label1\":\"Cancel restart\",\t  \"notificationId\": flow.notificationId,\t  \"devices\":[\"brad\"]\t}","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":578,"y":511,"wires":[["8ecda162.2b3c7"]]},{"id":"8ecda162.2b3c7","type":"subflow:8f5573e3.e52df","z":"98e70926.543948","name":"","x":772,"y":509,"wires":[[]]},{"id":"cf68be4b.330de","type":"uuid","z":"98e70926.543948","uuidVersion":"v4","namespaceType":"","namespace":"","namespaceCustom":"","name":"","field":"notificationId","fieldType":"flow","x":396.5,"y":511,"wires":[["c5ffb365.09e9b"]]},{"id":"d6cbbaec.fa48d8","type":"server-state-changed","z":"98e70926.543948","name":"Travis CI Started","server":"5806b60f.c2e778","entityidfilter":"sensor.bhopkinsonhomeassistantconfig_state","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"started","halt_if_type":"str","halt_if_compare":"does_not_include","outputs":2,"x":168,"y":575,"wires":[[],[]]},{"id":"9ec1fded.c16e7","type":"inject","z":"98e70926.543948","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":true,"onceDelay":0.1,"x":231,"y":502,"wires":[["cf68be4b.330de"]]},{"id":"6d8cfe.b1d35304","type":"change","z":"8f5573e3.e52df","name":"Set Query String Parameters","rules":[{"t":"set","p":"payload","pt":"msg","to":"\"key=\" & payload.autoremote.key &\t\"&password=\" & payload.autoremote.password &\t\"&\" &\t$join(\t   $each(\t       payload.autoremote.message,\t       function($v, $k){\t            $k & \"=\" & ($v != null ? $v : \"\")\t       }\t   ),\t   \"&\"\t)","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":615.5,"y":56,"wires":[["36f8aac7.5a44f6"]]},{"id":"66b46068.4f9ed","type":"change","z":"98e70926.543948","name":"Set travis created message","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\t   \"autoremote\":{\t       \"message\":{\t           \"id\": flow.notificationId,\t           \"title\":\"Home Assistant\",\t           \"text\":\"Travis CI Created\",\t           \"icon\":\"https://www.home-assistant.io/images/components/alexa/alexa-108x108.png\",\t           \"action1name\":\"Cancel restart\",\t           \"action1\":\"cancelrestart id=\" & flow.notificationId\t       \t       },\t       \"devices\":[\"brad\"]\t\t   }\t\t}","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":688,"y":31,"wires":[["46bcb02f.25bf6","d8adbd1e.cdcf8"]]},{"id":"4932781a.217888","type":"uuid","z":"98e70926.543948","uuidVersion":"v4","namespaceType":"","namespace":"","namespaceCustom":"","name":"","field":"notificationId","fieldType":"flow","x":470,"y":31,"wires":[["66b46068.4f9ed"]]},{"id":"46bcb02f.25bf6","type":"subflow:8f5573e3.e52df","z":"98e70926.543948","name":"","x":927,"y":31,"wires":[[]]},{"id":"30b66512.22915a","type":"change","z":"98e70926.543948","name":"Set travis started message","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\t   \"autoremote\":{\t       \"message\":{\t           \"id\": flow.notificationId,\t           \"title\": \"Home Assistant\",\t           \"text\": \"Travis CI Started\",\t           \"icon\": \"https://www.home-assistant.io/images/components/alexa/alexa-108x108.png\",\t           \"indeterminateprogress\": true,\t           \"action1name\": payload != flow.notificationId ? \"Cancel restart\" : null,\t           \"action1\": payload != flow.notificationId ? \"cancelrestart id=\" & flow.notificationId : null\t   \t   \t       },\t       \"devices\":[\"brad\"]\t\t   }\t\t}","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":789,"y":82,"wires":[["d5019e5c.b32eb","d8adbd1e.cdcf8"]]},{"id":"6593da06.13ca84","type":"api-current-state","z":"98e70926.543948","name":"Get cancellation token","server":"5806b60f.c2e778","halt_if":"","halt_if_type":"str","halt_if_compare":"is","override_topic":true,"override_payload":true,"override_data":true,"entity_id":"sensor.homeassistantrestartcancellationtoken","state_type":"str","outputs":1,"x":520.5,"y":82,"wires":[["30b66512.22915a"]]},{"id":"d5019e5c.b32eb","type":"subflow:8f5573e3.e52df","z":"98e70926.543948","name":"","x":1026,"y":82,"wires":[[]]},{"id":"df7f8877.52b368","type":"api-current-state","z":"98e70926.543948","name":"Get cancellation token","server":"5806b60f.c2e778","halt_if":"","halt_if_type":"str","halt_if_compare":"is","override_topic":true,"override_payload":true,"override_data":true,"entity_id":"sensor.homeassistantrestartcancellationtoken","state_type":"str","outputs":1,"x":522,"y":136,"wires":[["1dab0a2.0c4cff6"]]},{"id":"1dab0a2.0c4cff6","type":"change","z":"98e70926.543948","name":"Set travis passed message","rules":[{"t":"set","p":"payload.autoremote","pt":"msg","to":"{\t   \"autoremote\":{\t       \"message\":{\t           \"id\": flow.notificationId,\t           \"title\": \"Home Assistant\",\t           \"text\": \"Travis CI Passed\",\t           \"icon\": \"https://www.home-assistant.io/images/components/alexa/alexa-108x108.png\",\t           \"indeterminateprogress\": payload != flow.notificationId ? true : null\t   \t   \t       },\t       \"devices\":[\"brad\"]\t\t   }\t\t}","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":790,"y":136,"wires":[["1aae6511.0daf9b"]]},{"id":"1aae6511.0daf9b","type":"subflow:8f5573e3.e52df","z":"98e70926.543948","name":"","x":1027,"y":136,"wires":[["b0e241f5.f850a"]]},{"id":"da50b0fd.ca3fd","type":"http request","z":"98e70926.543948","name":"Pull Config","method":"GET","ret":"txt","url":"http://192.168.0.10:9002/hooks/git-pull","tls":"","x":1397,"y":136,"wires":[["cc85c102.81e67"]]},{"id":"b0e241f5.f850a","type":"change","z":"98e70926.543948","name":"Set config folder","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\"folder\":\"/hass-config\"}","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":1212.5,"y":136,"wires":[["da50b0fd.ca3fd"]]},{"id":"cc85c102.81e67","type":"switch","z":"98e70926.543948","name":"OK?","property":"statusCode","propertyType":"msg","rules":[{"t":"eq","v":"200","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":1555,"y":136,"wires":[["85c637e1.028748"]]},{"id":"85c637e1.028748","type":"api-current-state","z":"98e70926.543948","name":"Get cancellation token","server":"5806b60f.c2e778","halt_if":"","halt_if_type":"str","halt_if_compare":"is","override_topic":true,"override_payload":true,"override_data":true,"entity_id":"sensor.homeassistantrestartcancellationtoken","state_type":"str","outputs":1,"x":1743,"y":136,"wires":[["f5e45848.39b8d8"]]},{"id":"f5e45848.39b8d8","type":"switch","z":"98e70926.543948","name":"cancelled?","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"notificationId","vt":"flow"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":1947.5,"y":136,"wires":[["8e39ad25.a4c72"],["82a169f9.1288b8"]]},{"id":"8e39ad25.a4c72","type":"change","z":"98e70926.543948","name":"Set travis passed message","rules":[{"t":"set","p":"payload.autoremote","pt":"msg","to":"{\t   \"message\":{\t       \"id\": flow.notificationId,\t       \"title\": \"Home Assistant\",\t       \"text\": \"Config updated. Please restart manually.\",\t       \"icon\": \"https://www.home-assistant.io/images/components/alexa/alexa-108x108.png\"\t   \t   },\t   \"devices\":[\"brad\"]\t\t}","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":2186,"y":105,"wires":[["57c6a06e.97e97"]]},{"id":"57c6a06e.97e97","type":"subflow:8f5573e3.e52df","z":"98e70926.543948","name":"","x":2422,"y":105,"wires":[[]]},{"id":"82a169f9.1288b8","type":"change","z":"98e70926.543948","name":"Set travis passed message","rules":[{"t":"set","p":"payload.autoremote","pt":"msg","to":"{\t   \"message\":{\t       \"id\": flow.notificationId,\t       \"title\": \"Home Assistant\",\t       \"text\": \"Config updated. Restarting...\",\t       \"icon\": \"https://www.home-assistant.io/images/components/alexa/alexa-108x108.png\",\t       \"indeterminateprogress\": true\t   },\t   \"devices\":[\"brad\"]\t\t}","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":2188,"y":158,"wires":[["c7d3946d.c52c68"]]},{"id":"c7d3946d.c52c68","type":"subflow:8f5573e3.e52df","z":"98e70926.543948","name":"","x":2422,"y":158,"wires":[[]]},{"id":"7dbe6af.1c7ec94","type":"api-call-service","z":"98e70926.543948","name":"Restart","server":"5806b60f.c2e778","service_domain":"homeassistant","service":"restart","data":"","render_data":false,"mergecontext":"","output_location":"payload","output_location_type":"msg","x":2596,"y":158,"wires":[[]]},{"id":"57be8d4b.de3454","type":"inject","z":"98e70926.543948","name":"","topic":"","payload":"started","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":168,"y":173,"wires":[["91f6432.8213ac"]]},{"id":"43058c12.66eeb4","type":"inject","z":"98e70926.543948","name":"","topic":"","payload":"passed","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":168,"y":209,"wires":[["91f6432.8213ac"]]}]