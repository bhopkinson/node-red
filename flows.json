[{"id":"98e70926.543948","type":"tab","label":"Home Assistant","disabled":false,"info":""},{"id":"257e9eaf.a9d202","type":"tab","label":"Brad","disabled":false,"info":""},{"id":"6076e8bd.b0fe58","type":"tab","label":"Tado","disabled":false,"info":""},{"id":"3e06a286.f1fcfe","type":"tab","label":"Sandbox","disabled":false,"info":""},{"id":"98bf1f56.6da51","type":"tab","label":"Lights","disabled":false,"info":""},{"id":"9943920f.042cc","type":"tab","label":"Emails","disabled":false,"info":""},{"id":"2340bc28.5813f4","type":"tab","label":"Zigbee2Mqtt Admin","disabled":true,"info":""},{"id":"8f5573e3.e52df","type":"subflow","name":"AutoRemote","info":"","category":"","in":[{"x":48,"y":61,"wires":[{"id":"85c3663c.2deeb8"}]}],"out":[{"x":1649,"y":59,"wires":[{"id":"36f8aac7.5a44f6","port":0},{"id":"86433a5c.eb5228","port":0}]}]},{"id":"12d32bdb.3c9804","type":"subflow","name":"Set Tasker Variable","info":"","category":"","in":[{"x":71,"y":68,"wires":[{"id":"cc4dda7c.021558"}]}],"out":[{"x":570,"y":68,"wires":[{"id":"565c25d.7e677dc","port":0}]}],"env":[]},{"id":"c26c68e9.a7fd88","type":"subflow","name":"Update Enable Status","info":"","category":"","in":[{"x":44,"y":256,"wires":[{"id":"cbbb64af.32dd18"}]}],"out":[{"x":1734,"y":234,"wires":[{"id":"c5447f3c.01585","port":0},{"id":"76084fd2.b061","port":1},{"id":"35d84bb9.f1c014","port":0},{"id":"4ccf8e7b.8482c","port":0}]}],"env":[]},{"id":"94dca4da.a92a08","type":"subflow","name":"Start MQTT Timer","info":"","category":"","in":[{"x":68,"y":53,"wires":[{"id":"620a2cff.9f70e4"}]}],"out":[],"env":[]},{"id":"9f58257c.b55cc8","type":"subflow","name":"Network Map","info":"","category":"Zigbee2MQTT Admin Panel","in":[],"out":[]},{"id":"a13d547b.c3be08","type":"subflow","name":"Pairing Notifications","info":"","category":"Zigbee2MQTT Admin Panel","in":[],"out":[]},{"id":"3db3968f.235e2a","type":"subflow","name":"Devices","info":"","category":"Zigbee2MQTT Admin Panel","in":[],"out":[]},{"id":"e0298c5b.a16c5","type":"subflow","name":"Status","info":"","category":"Zigbee2MQTT Admin Panel","in":[],"out":[]},{"id":"985d4e07.a55e2","type":"subflow","name":"Logging Level","info":"","category":"Zigbee2MQTT Admin Panel","in":[],"out":[]},{"id":"6598b10d.6ea72","type":"subflow","name":"Remove Device","info":"","category":"Zigbee2MQTT Admin Panel","in":[],"out":[]},{"id":"db3d1c60.309a3","type":"subflow","name":"Permit Join","info":"","category":"Zigbee2MQTT Admin Panel","in":[],"out":[]},{"id":"f72bc520.d84698","type":"subflow","name":"Rename Device","info":"","category":"Zigbee2MQTT Admin Panel","in":[],"out":[]},{"id":"2837753f.46f60a","type":"subflow","name":"Canopy lights","info":"","category":"","in":[{"x":80,"y":216,"wires":[{"id":"10d93d0e.21a2b3"}]}],"out":[{"x":1367,"y":217,"wires":[{"id":"2f41a89a.ac8d08","port":0}]}],"env":[]},{"id":"5806b60f.c2e778","type":"server","z":"","name":"Home Assistant","legacy":false,"hassio":false,"rejectUnauthorizedCerts":true,"ha_boolean":"y|yes|true|on|home|open"},{"id":"ab404be4.584f18","type":"mqtt-broker","z":"","name":"mosquitto","broker":"192.168.0.10","port":"1883","clientid":"node-red","usetls":false,"compatmode":true,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthPayload":"","closeTopic":"","closeQos":"0","closePayload":"","willTopic":"","willQos":"0","willPayload":""},{"id":"cd542645.b771b8","type":"ui_group","z":"3db3968f.235e2a","name":"Devices","tab":"cc997341.c91d9","order":1,"disp":true,"width":"12","collapse":false},{"id":"6aef0367.061cac","type":"ui_group","z":"","name":"Status","tab":"cc997341.c91d9","order":2,"disp":true,"width":"6","collapse":false},{"id":"795ffc67.304ee4","type":"ui_group","z":"985d4e07.a55e2","name":"Logging Level","tab":"cc997341.c91d9","order":4,"disp":true,"width":"6","collapse":false},{"id":"5fdce667.2f2e18","type":"ui_group","z":"6598b10d.6ea72","name":"Remove Device","tab":"cc997341.c91d9","order":5,"disp":true,"width":"6","collapse":false},{"id":"88e9fbfc.45f488","type":"ui_group","z":"","name":"Permit Join","tab":"cc997341.c91d9","order":3,"disp":true,"width":"6","collapse":false},{"id":"8319e184.2e15a","type":"ui_group","z":"","name":"Rename Device","tab":"cc997341.c91d9","order":6,"disp":true,"width":"6","collapse":false},{"id":"cc997341.c91d9","type":"ui_tab","z":"","name":"Zigbee2MQTT Admin Panel","icon":"dashboard"},{"id":"2279a56a.821bca","type":"ui_base","theme":{"name":"theme-dark","lightTheme":{"default":"#0094CE","baseColor":"#0094CE","baseFont":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif","edited":true,"reset":false},"darkTheme":{"default":"#097479","baseColor":"#097479","baseFont":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif","edited":true,"reset":false},"customTheme":{"name":"Untitled Theme 1","default":"#4B7930","baseColor":"#4B7930","baseFont":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif"},"themeState":{"base-color":{"default":"#097479","value":"#097479","edited":false},"page-titlebar-backgroundColor":{"value":"#097479","edited":false},"page-backgroundColor":{"value":"#111111","edited":false},"page-sidebar-backgroundColor":{"value":"#000000","edited":false},"group-textColor":{"value":"#0eb8c0","edited":false},"group-borderColor":{"value":"#555555","edited":false},"group-backgroundColor":{"value":"#333333","edited":false},"widget-textColor":{"value":"#eeeeee","edited":false},"widget-backgroundColor":{"value":"#097479","edited":false},"widget-borderColor":{"value":"#333333","edited":false},"base-font":{"value":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif"}},"angularTheme":{"primary":"indigo","accents":"blue","warn":"red","background":"grey"}},"site":{"name":"Node-RED Dashboard","hideToolbar":"false","allowSwipe":"false","lockMenu":"false","allowTempTheme":"true","dateFormat":"DD/MM/YYYY","sizes":{"sx":48,"sy":48,"gx":6,"gy":6,"cx":6,"cy":6,"px":0,"py":0}}},{"id":"b7b614a.22dc4e8","type":"server-state-changed","z":"98e70926.543948","name":"Travis CI passed","server":"5806b60f.c2e778","entityidfilter":"sensor.bhopkinson_home_assistant_config_state","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"","halt_if_type":"str","halt_if_compare":"is","outputs":1,"output_only_on_state_change":false,"x":132.50008392333984,"y":79.7500810623169,"wires":[["91f6432.8213ac"]]},{"id":"85c3663c.2deeb8","type":"switch","z":"8f5573e3.e52df","name":"device switch","property":"payload.autoremote.devices","propertyType":"msg","rules":[{"t":"cont","v":"all","vt":"str"},{"t":"cont","v":"brad","vt":"str"},{"t":"cont","v":"heather","vt":"str"}],"checkall":"true","repair":false,"outputs":3,"x":177.5,"y":61,"wires":[["ab669dc4.44ee8","f29cbe54.442f4"],["ab669dc4.44ee8"],["f29cbe54.442f4"]]},{"id":"36f8aac7.5a44f6","type":"http request","z":"8f5573e3.e52df","name":"Send notification","method":"GET","ret":"txt","url":"https://autoremotejoaomgcd.appspot.com/sendnotification?{{{payload}}}","tls":"","x":1447.5,"y":40,"wires":[[]]},{"id":"93abf424.a7e898","type":"inject","z":"98e70926.543948","name":"","topic":"","payload":"created","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":168.50008392333984,"y":139.7500810623169,"wires":[["91f6432.8213ac"]]},{"id":"ab669dc4.44ee8","type":"delay","z":"8f5573e3.e52df","name":"","pauseType":"timed","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":true,"x":401,"y":42,"wires":[["a00146e.1235fb8"]]},{"id":"a00146e.1235fb8","type":"credentials","z":"8f5573e3.e52df","name":"Set AutoRemote Credentials for Brad","props":[{"value":"payload.autoremote.key","type":"msg"},{"value":"payload.autoremote.password","type":"msg"}],"x":687,"y":41,"wires":[["9c121cf5.aa789","113a7204.3de1ae"]]},{"id":"e0247ece.0def8","type":"credentials","z":"8f5573e3.e52df","name":"Set AutoRemote Credentials for Heather","props":[{"value":"payload.autoremote.key","type":"msg"},{"value":"payload.autoremote.password","type":"msg"}],"x":679,"y":78,"wires":[["9c121cf5.aa789","113a7204.3de1ae"]]},{"id":"f29cbe54.442f4","type":"delay","z":"8f5573e3.e52df","name":"","pauseType":"timed","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":true,"x":401,"y":78,"wires":[["e0247ece.0def8"]]},{"id":"91f6432.8213ac","type":"switch","z":"98e70926.543948","name":"","property":"payload","propertyType":"msg","rules":[{"t":"cont","v":"created","vt":"str"},{"t":"cont","v":"started","vt":"str"},{"t":"cont","v":"passed","vt":"str"}],"checkall":"false","repair":false,"outputs":3,"x":317.50008392333984,"y":79.7500810623169,"wires":[["4932781a.217888"],["30b66512.22915a"],["1dab0a2.0c4cff6"]],"outputLabels":["created","started","passed"]},{"id":"6d8cfe.b1d35304","type":"change","z":"8f5573e3.e52df","name":"Set Query String Parameters","rules":[{"t":"set","p":"payload","pt":"msg","to":"\"key=\" & payload.autoremote.key &\t\"&password=\" & payload.autoremote.password &\t\"&\" &\t$join(\t   $each(\t       payload.autoremote.notification,\t       function($v, $k){\t            $k & \"=\" & ($v != null ? $v : \"\")\t       }\t   ),\t   \"&\"\t)","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":1193.5,"y":40,"wires":[["36f8aac7.5a44f6"]]},{"id":"66b46068.4f9ed","type":"change","z":"98e70926.543948","name":"Set travis created message","rules":[{"t":"set","p":"payload","pt":"msg","to":"(\t   $notificationId := $flowContext(\"notificationId\");\t   {\t       \"autoremote\":{\t           \"notification\":{\t               \"id\": $notificationId,\t               \"title\":\"Home Assistant\",\t               \"text\":\"Travis CI Created\",\t               \"icon\":\"https://www.home-assistant.io/images/components/alexa/alexa-108x108.png\",\t               \"action1name\":\"Cancel restart\",\t               \"action1\":\"cancelrestart id=:=\" & $notificationId\t           },\t           \"devices\":[\"brad\"]\t \t       }\t\t   }\t\t)","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":688.0000839233398,"y":32.750081062316895,"wires":[["46bcb02f.25bf6"]]},{"id":"4932781a.217888","type":"uuid","z":"98e70926.543948","uuidVersion":"v4","namespaceType":"","namespace":"","namespaceCustom":"","name":"","field":"notificationId","fieldType":"flow","x":470.00008392333984,"y":32.750081062316895,"wires":[["66b46068.4f9ed"]]},{"id":"46bcb02f.25bf6","type":"subflow:8f5573e3.e52df","z":"98e70926.543948","name":"","x":927.0000839233398,"y":32.750081062316895,"wires":[[]]},{"id":"30b66512.22915a","type":"change","z":"98e70926.543948","name":"Set travis started message","rules":[{"t":"set","p":"payload","pt":"msg","to":"(\t   $notifcationId := $flowContext(\"notificationId\");\t   $canellationToken := $flowContext(\"cancellationToken\");\t   $cancelled := $notifcationId = $canellationToken;\t   {\t       \"autoremote\":{\t           \"notification\":{\t               \"id\": $notifcationId,\t               \"title\": \"Home Assistant\",\t               \"text\": \"Travis CI Started\",\t               \"icon\": \"https://www.home-assistant.io/images/components/alexa/alexa-108x108.png\",\t               \"indeterminateprogress\": true,\t               \"action1name\": $cancelled ? \"Cancel restart\" : null,\t               \"action1\": $cancelled ? \"cancelrestart id=\" & $notifcationId : null\t   \t   \t       \t           },\t           \"devices\":[\"brad\"]\t\t   \t       }\t\t\t   }\t\t)","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":540.0000839233398,"y":78.7500810623169,"wires":[["d5019e5c.b32eb"]]},{"id":"d5019e5c.b32eb","type":"subflow:8f5573e3.e52df","z":"98e70926.543948","name":"","x":777.0000839233398,"y":78.7500810623169,"wires":[[]]},{"id":"1dab0a2.0c4cff6","type":"change","z":"98e70926.543948","name":"Set travis passed message","rules":[{"t":"set","p":"payload","pt":"msg","to":"(\t$notificationId := $flowContext(\"notificationId\");\t$canellationToken := $flowContext(\"cancellationToken\");\t$cancelled := $notifcationId = $canellationToken;\t{\t   \"autoremote\":{\t       \"notification\":{\t           \"id\": $notificationId,\t           \"title\": \"Home Assistant\",\t           \"text\": \"Travis CI Passed\",\t           \"icon\": \"https://www.home-assistant.io/images/components/alexa/alexa-108x108.png\",\t           \"indeterminateprogress\": $cancelled ? true : null\t  \t       },\t       \"devices\":[\"brad\"]\t\t   }\t\t}\t)","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":541.0000839233398,"y":132.7500810623169,"wires":[["1aae6511.0daf9b"]]},{"id":"1aae6511.0daf9b","type":"subflow:8f5573e3.e52df","z":"98e70926.543948","name":"","x":778.0000839233398,"y":132.7500810623169,"wires":[["da50b0fd.ca3fd"]]},{"id":"da50b0fd.ca3fd","type":"http request","z":"98e70926.543948","name":"Pull Config","method":"GET","ret":"txt","paytoqs":false,"url":"http://192.168.0.10:9002/hooks/git-pull?folder=hass-config","tls":"","proxy":"","x":954.0000839233398,"y":132.7500810623169,"wires":[["cc85c102.81e67"]]},{"id":"cc85c102.81e67","type":"switch","z":"98e70926.543948","name":"OK?","property":"statusCode","propertyType":"msg","rules":[{"t":"eq","v":"200","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":1112.0000839233398,"y":132.7500810623169,"wires":[["f5e45848.39b8d8"]]},{"id":"f5e45848.39b8d8","type":"switch","z":"98e70926.543948","name":"cancelled?","property":"cancellationToken","propertyType":"flow","rules":[{"t":"eq","v":"notificationId","vt":"flow"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":1275.5000839233398,"y":132.7500810623169,"wires":[["8e39ad25.a4c72"],["82a169f9.1288b8"]]},{"id":"8e39ad25.a4c72","type":"change","z":"98e70926.543948","name":"Set manual restart message","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\t   \"autoremote\":{\t       \"notification\":{\t           \"id\": $flowContext(\"notificationId\"),\t           \"title\": \"Home Assistant\",\t           \"text\": \"Config updated. Please restart manually.\",\t           \"icon\": \"https://www.home-assistant.io/images/components/alexa/alexa-108x108.png\"\t          },\t       \"devices\":[\"brad\"]\t\t   }\t\t}","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":1514.0000839233398,"y":101.7500810623169,"wires":[["57c6a06e.97e97"]]},{"id":"57c6a06e.97e97","type":"subflow:8f5573e3.e52df","z":"98e70926.543948","name":"","x":1750.0000839233398,"y":101.7500810623169,"wires":[[]]},{"id":"82a169f9.1288b8","type":"change","z":"98e70926.543948","name":"Set config updated message","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\t   \"autoremote\":{\t       \"notification\":{\t           \"id\": $flowContext(\"notificationId\"),\t           \"title\": \"Home Assistant\",\t           \"text\": \"Config updated\",\t           \"icon\": \"https://www.home-assistant.io/images/components/alexa/alexa-108x108.png\"\t       },\t       \"devices\":[\"brad\"]\t\t   }\t\t}","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":1516.0000839233398,"y":154.7500810623169,"wires":[["c7d3946d.c52c68"]]},{"id":"c7d3946d.c52c68","type":"subflow:8f5573e3.e52df","z":"98e70926.543948","name":"","x":1750.0000839233398,"y":154.7500810623169,"wires":[["1e050fea.b2ba2"]]},{"id":"7dbe6af.1c7ec94","type":"api-call-service","z":"98e70926.543948","name":"Restart","server":"5806b60f.c2e778","service_domain":"homeassistant","service":"restart","data":"","mergecontext":"","output_location":"payload","output_location_type":"msg","x":2127.00008392334,"y":154.7500810623169,"wires":[[]]},{"id":"57be8d4b.de3454","type":"inject","z":"98e70926.543948","name":"","topic":"","payload":"started","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":168.00008392333984,"y":174.7500810623169,"wires":[["91f6432.8213ac"]]},{"id":"43058c12.66eeb4","type":"inject","z":"98e70926.543948","name":"","topic":"","payload":"passed","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":168.00008392333984,"y":210.7500810623169,"wires":[["91f6432.8213ac"]]},{"id":"1e050fea.b2ba2","type":"change","z":"98e70926.543948","name":"Set restarted flag","rules":[{"t":"set","p":"restarted","pt":"flow","to":"true","tot":"bool"}],"action":"","property":"","from":"","to":"","reg":false,"x":1945.5000839233398,"y":154.7500810623169,"wires":[["7dbe6af.1c7ec94"]]},{"id":"a1daca7e.1b4ad8","type":"mqtt in","z":"98e70926.543948","name":"Cancel restart token","topic":"orchardhouse/homeassistant/restart/cancel","qos":"1","broker":"ab404be4.584f18","x":361.50008392333984,"y":187.7500810623169,"wires":[["acfd340a.28bda8"]]},{"id":"97dfd900.4cc2b8","type":"change","z":"98e70926.543948","name":"","rules":[{"t":"set","p":"cancellationToken","pt":"flow","to":"payload.token","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":728.5000839233398,"y":187.7500810623169,"wires":[[]]},{"id":"acfd340a.28bda8","type":"json","z":"98e70926.543948","name":"","property":"payload","action":"obj","pretty":false,"x":528.5000839233398,"y":187.7500810623169,"wires":[["97dfd900.4cc2b8"]]},{"id":"b3b2157.32adee8","type":"change","z":"257e9eaf.a9d202","name":"Set makecall message","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\t   \"autoremote\":{\t       \"message\":{\t           \"message\": \"makecall number=:=\" & glenngatenumber,\t           \"ttl\": 180\t       },\t       \"devices\":[\"brad\"]\t   }\t}","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":1189,"y":68,"wires":[["61d1a7ef.0a9298"]]},{"id":"113a7204.3de1ae","type":"switch","z":"8f5573e3.e52df","name":"Notifcation?","property":"payload.autoremote.notification","propertyType":"msg","rules":[{"t":"nnull"}],"checkall":"true","repair":false,"outputs":1,"x":980.5,"y":40,"wires":[["6d8cfe.b1d35304"]]},{"id":"9c121cf5.aa789","type":"switch","z":"8f5573e3.e52df","name":"Message?","property":"payload.autoremote.message","propertyType":"msg","rules":[{"t":"nnull"}],"checkall":"true","repair":false,"outputs":1,"x":980,"y":78,"wires":[["a0f3224c.67cb6"]]},{"id":"a0f3224c.67cb6","type":"change","z":"8f5573e3.e52df","name":"Set Query String Parameters","rules":[{"t":"set","p":"payload","pt":"msg","to":"\"key=\" & payload.autoremote.key &\t\"&password=\" & payload.autoremote.password &\t\"&\" &\t$join(\t   $each(\t       payload.autoremote.message,\t       function($v, $k){\t            $k & \"=\" & ($v != null ? $v : \"\")\t       }\t   ),\t   \"&\"\t)","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":1195,"y":79,"wires":[["86433a5c.eb5228"]]},{"id":"86433a5c.eb5228","type":"http request","z":"8f5573e3.e52df","name":"Send message","method":"GET","ret":"txt","url":"https://autoremotejoaomgcd.appspot.com/sendmessage?{{{payload}}}","tls":"","x":1439,"y":79,"wires":[[]]},{"id":"1de5058b.2aaa1a","type":"time-range-switch","z":"257e9eaf.a9d202","name":"Is gate closed time","lat":"","lon":"","startTime":"19:15","endTime":"20:30","startOffset":0,"endOffset":0,"x":706.5,"y":70,"wires":[["f50b7dda.616af"],[]],"outputLabels":["true","false"]},{"id":"f50b7dda.616af","type":"credentials","z":"257e9eaf.a9d202","name":"Get Glenn's Gate Number","props":[{"value":"glenngatenumber","type":"msg"}],"x":951.5,"y":68,"wires":[["b3b2157.32adee8"]]},{"id":"61d1a7ef.0a9298","type":"subflow:8f5573e3.e52df","z":"257e9eaf.a9d202","name":"","x":1392,"y":68,"wires":[[]]},{"id":"b42c7c46.3336a","type":"server-state-changed","z":"257e9eaf.a9d202","name":"SEAT LEON","server":"5806b60f.c2e778","entityidfilter":"binary_sensor.brad_mobile_seat_leon","entityidfiltertype":"exact","outputinitially":false,"state_type":"habool","haltifstate":"","halt_if_type":"str","halt_if_compare":"is","outputs":1,"x":95.5,"y":77,"wires":[["ac43316.cc6d7d"]]},{"id":"c4ef01e5.21708","type":"api-current-state","z":"257e9eaf.a9d202","name":"Is at BTB","server":"5806b60f.c2e778","outputs":2,"halt_if":"BTB HQ","halt_if_type":"str","halt_if_compare":"is_not","override_topic":true,"entity_id":"person.brad","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":527.5,"y":71,"wires":[["1de5058b.2aaa1a"],[]]},{"id":"ac43316.cc6d7d","type":"switch","z":"257e9eaf.a9d202","name":"Connected?","property":"payload","propertyType":"msg","rules":[{"t":"true"},{"t":"else"}],"checkall":"false","repair":false,"outputs":2,"x":257.5,"y":77,"wires":[["c4ef01e5.21708"],[]]},{"id":"a3cdedc2.de645","type":"server-state-changed","z":"257e9eaf.a9d202","name":"In office sensor","server":"5806b60f.c2e778","entityidfilter":"binary_sensor.brad_in_office","entityidfiltertype":"substring","outputinitially":false,"state_type":"str","haltifstate":"","halt_if_type":"str","halt_if_compare":"is","outputs":1,"x":106.5,"y":211,"wires":[["5d7c6637.090738","1cdfff07.0728b1"]]},{"id":"12efefef.33632","type":"comment","z":"98e70926.543948","name":"Home assistant config build & restart","info":"","x":163.50008392333984,"y":26.750081062316895,"wires":[]},{"id":"4d92cd5d.b20464","type":"http in","z":"257e9eaf.a9d202","name":"","url":"/api/enable/status","method":"get","upload":false,"swaggerDoc":"","x":649.5,"y":472,"wires":[["496ad26e.7314cc"]]},{"id":"128530b6.a7587f","type":"http response","z":"257e9eaf.a9d202","name":"response","statusCode":"","headers":{},"x":1455.5,"y":490,"wires":[]},{"id":"6da8f4a1.cee32c","type":"http request","z":"c26c68e9.a7fd88","name":"","method":"use","ret":"obj","url":"http://orchardhouse-functions/api/enable/status?username={{{enable.username}}}&passwordBase={{{enable.passwordBase}}}&currentInteger={{{currentInteger}}}","tls":"","x":446,"y":225,"wires":[["76084fd2.b061","d458071.bfec2f8"]]},{"id":"e47d55aa.5af588","type":"credentials","z":"c26c68e9.a7fd88","name":"Enable Credentials","props":[{"value":"enable.username","type":"msg"},{"value":"enable.passwordBase","type":"msg"}],"x":259,"y":253,"wires":[["6da8f4a1.cee32c","c7d84542.3cb668"]]},{"id":"ddbf2335.1ecbc","type":"api-current-state","z":"257e9eaf.a9d202","name":"Current Password Integer","server":"5806b60f.c2e778","outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","override_topic":true,"entity_id":"input_number.enable_current_password_integer","state_type":"num","state_location":"currentInteger","override_payload":"msg","entity_location":"data","override_data":"msg","x":1014.5,"y":490,"wires":[["a8a26d9b.4a055"]]},{"id":"c5447f3c.01585","type":"change","z":"c26c68e9.a7fd88","name":"set status response","rules":[{"t":"set","p":"payload","pt":"msg","to":"actualstatus","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1559,"y":174,"wires":[["9238ad73.06261"]]},{"id":"1d233293.0bf51d","type":"switch","z":"c26c68e9.a7fd88","name":"New integer?","property":"payload.currentInteger","propertyType":"msg","rules":[{"t":"neq","v":"data.state","vt":"msg"}],"checkall":"true","repair":false,"outputs":1,"x":826,"y":196,"wires":[["85d490f.155c07"]]},{"id":"735f46c0.686328","type":"api-call-service","z":"c26c68e9.a7fd88","name":"Set Current Password Integer","server":"5806b60f.c2e778","service_domain":"input_number","service":"set_value","data":"{\"entity_id\":\"input_number.enable_current_password_integer\"}","mergecontext":"","output_location":"","output_location_type":"none","x":1294,"y":196,"wires":[[]]},{"id":"85d490f.155c07","type":"change","z":"c26c68e9.a7fd88","name":"New current integer value","rules":[{"t":"set","p":"payload.data.value","pt":"msg","to":"payload.currentInteger","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1029,"y":196,"wires":[["735f46c0.686328"]]},{"id":"868ad6cf.999298","type":"http in","z":"257e9eaf.a9d202","name":"","url":"/api/enable/status","method":"put","upload":false,"swaggerDoc":"","x":650,"y":512,"wires":[["7576aa68.0aeff4"]]},{"id":"7576aa68.0aeff4","type":"change","z":"257e9eaf.a9d202","name":"PUT","rules":[{"t":"set","p":"method","pt":"msg","to":"PUT","tot":"str"},{"t":"set","p":"headers","pt":"msg","to":"{\"Content-Type\":\"application/json\"}","tot":"json"},{"t":"set","p":"payload","pt":"msg","to":"{\"status\":payload}","tot":"jsonata"},{"t":"set","p":"retry","pt":"msg","to":"0","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":821.5,"y":512,"wires":[["ddbf2335.1ecbc"]]},{"id":"496ad26e.7314cc","type":"change","z":"257e9eaf.a9d202","name":"GET","rules":[{"t":"set","p":"method","pt":"msg","to":"GET","tot":"str"},{"t":"set","p":"retry","pt":"msg","to":"0","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":821,"y":472,"wires":[["ddbf2335.1ecbc"]]},{"id":"5f18f13a.52f1","type":"api-call-service","z":"257e9eaf.a9d202","name":"Enable Status switch on","server":"5806b60f.c2e778","service_domain":"switch","service":"turn_on","data":"{\"entity_id\":\"switch.enable_status\"}","mergecontext":"","output_location":"","output_location_type":"none","x":541.5,"y":149,"wires":[[]]},{"id":"5d7c6637.090738","type":"switch","z":"257e9eaf.a9d202","name":"In office?","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"on","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":283.5,"y":173.8800048828125,"wires":[["5f18f13a.52f1"],["6820f743.d91ec8"]]},{"id":"6820f743.d91ec8","type":"api-call-service","z":"257e9eaf.a9d202","name":"Enable Status switch off","server":"5806b60f.c2e778","service_domain":"switch","service":"turn_off","data":"{\"entity_id\":\"switch.enable_status\"}","mergecontext":"","output_location":"","output_location_type":"none","x":540,"y":199,"wires":[[]]},{"id":"76084fd2.b061","type":"switch","z":"c26c68e9.a7fd88","name":"StatusCode","property":"statusCode","propertyType":"msg","rules":[{"t":"eq","v":"200","vt":"str"},{"t":"eq","v":"403","vt":"str"},{"t":"eq","v":"500","vt":"str"},{"t":"else"}],"checkall":"false","repair":false,"outputs":4,"x":617,"y":225,"wires":[["a1c65825.2e1fc8","1d233293.0bf51d"],[],["35d84bb9.f1c014"],["35d84bb9.f1c014"]],"outputLabels":["200","403","500","Other"]},{"id":"46f502a2.0241ec","type":"switch","z":"c26c68e9.a7fd88","name":"Does actual status match?","property":"actualstatus","propertyType":"msg","rules":[{"t":"neq","v":"expectedstatus ? 1 : 0","vt":"jsonata"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":1303,"y":148,"wires":[["f18b6049.21688"],["c5447f3c.01585"]],"outputLabels":["no","yes"]},{"id":"a1c65825.2e1fc8","type":"change","z":"c26c68e9.a7fd88","name":"Set actual status","rules":[{"t":"move","p":"payload.status","pt":"msg","to":"actualstatus","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":844,"y":148,"wires":[["80a57e32.9d226"]]},{"id":"80a57e32.9d226","type":"api-current-state","z":"c26c68e9.a7fd88","name":"Get expected status","server":"5806b60f.c2e778","outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","override_topic":false,"entity_id":"binary_sensor.brad_in_office","state_type":"habool","state_location":"expectedstatus","override_payload":"msg","entity_location":"data","override_data":"msg","x":1057,"y":148,"wires":[["46f502a2.0241ec","a72051a6.f03b6"]]},{"id":"f18b6049.21688","type":"change","z":"c26c68e9.a7fd88","name":"Set payload to expected status","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\"status\": expectedstatus ? 1 : 0}","tot":"jsonata"},{"t":"set","p":"method","pt":"msg","to":"PUT","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":552,"y":85,"wires":[["6da8f4a1.cee32c","c6336576.216a98"]]},{"id":"35d84bb9.f1c014","type":"switch","z":"c26c68e9.a7fd88","name":"retry?","property":"retry","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"num"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":807,"y":248,"wires":[[],["d4e526e7.48e878"]],"outputLabels":["> 0","<= 0"]},{"id":"ef3780a8.b8d5d","type":"delay","z":"c26c68e9.a7fd88","name":"","pauseType":"delay","timeout":"10","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":618,"y":306,"wires":[["a1c65825.2e1fc8","26498ff5.5e3fb"]]},{"id":"d4e526e7.48e878","type":"change","z":"c26c68e9.a7fd88","name":"","rules":[{"t":"set","p":"retry","pt":"msg","to":"1","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":470,"y":306,"wires":[["ef3780a8.b8d5d"]]},{"id":"26498ff5.5e3fb","type":"debug","z":"c26c68e9.a7fd88","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":776,"y":306,"wires":[]},{"id":"d458071.bfec2f8","type":"debug","z":"c26c68e9.a7fd88","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":597,"y":168,"wires":[]},{"id":"a72051a6.f03b6","type":"debug","z":"c26c68e9.a7fd88","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":1225,"y":80,"wires":[]},{"id":"9238ad73.06261","type":"debug","z":"c26c68e9.a7fd88","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":1763,"y":174,"wires":[]},{"id":"c6336576.216a98","type":"debug","z":"c26c68e9.a7fd88","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":786,"y":85,"wires":[]},{"id":"c7d84542.3cb668","type":"debug","z":"c26c68e9.a7fd88","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":426,"y":260,"wires":[]},{"id":"e6f0b254.c1d7a","type":"comment","z":"257e9eaf.a9d202","name":"In the office status","info":"","x":98.5,"y":163,"wires":[]},{"id":"13320b57.601375","type":"mqtt in","z":"3e06a286.f1fcfe","name":"","topic":"shellies/#","qos":"2","datatype":"auto","broker":"ab404be4.584f18","x":172.5,"y":95,"wires":[["dfdcad47.9b728"]]},{"id":"dfdcad47.9b728","type":"debug","z":"3e06a286.f1fcfe","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":486.5,"y":96,"wires":[]},{"id":"ef1bbf33.8bf2e","type":"mqtt out","z":"3e06a286.f1fcfe","name":"","topic":"shellies/command","qos":"0","retain":"false","broker":"ab404be4.584f18","x":303.5,"y":221,"wires":[]},{"id":"c03bf481.29e5f8","type":"inject","z":"3e06a286.f1fcfe","name":"","topic":"","payload":"update","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":107.5,"y":227,"wires":[["ef1bbf33.8bf2e"]]},{"id":"9b228951.643b18","type":"inject","z":"98e70926.543948","name":"HASS Connected?","topic":"","payload":"homeassistant.homeAssistant.isConnected","payloadType":"global","repeat":"1","crontab":"","once":false,"onceDelay":0.1,"x":140.00008392333984,"y":310.7500810623169,"wires":[["66fa41bf.6137d"]]},{"id":"66fa41bf.6137d","type":"rbe","z":"98e70926.543948","name":"","func":"rbei","gap":"","start":"","inout":"out","property":"payload","x":310.00008392333984,"y":310.7500810623169,"wires":[["75873d45.3d76e4"]]},{"id":"75873d45.3d76e4","type":"switch","z":"98e70926.543948","name":"","property":"payload","propertyType":"msg","rules":[{"t":"true"},{"t":"else"}],"checkall":"false","repair":false,"outputs":2,"x":430.00008392333984,"y":310.7500810623169,"wires":[["fe37facc.60fd58"],["6e7af992.aebe38"]]},{"id":"b3056446.849858","type":"change","z":"98e70926.543948","name":"Set home assistant online message","rules":[{"t":"set","p":"payload","pt":"msg","to":"(\t   $restarted := $flowContext(\"restarted\");\t   $notificationId := $restarted ? $flowContext(\"notificationId\") : msg.topic;\t   {\t       \"autoremote\":{\t           \"notification\":{\t               \"id\": $notificationId,\t               \"title\":\"Home Assistant\",\t               \"text\":$restarted ? \"Restart complete\" : \"Online\",\t               \"icon\":\"https://www.home-assistant.io/images/components/alexa/alexa-108x108.png\"\t           },\t           \"devices\":[\"brad\"]\t \t       }\t\t   }\t\t)","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":1051.0000839233398,"y":284.7500810623169,"wires":[["f26e1718.360828","f1d01ae2.4271a8"]]},{"id":"f26e1718.360828","type":"change","z":"98e70926.543948","name":"set restarted flag = false","rules":[{"t":"set","p":"restarted","pt":"flow","to":"false","tot":"bool"}],"action":"","property":"","from":"","to":"","reg":false,"x":1339.0000839233398,"y":284.7500810623169,"wires":[[]]},{"id":"6e851f70.6d24a","type":"subflow:8f5573e3.e52df","z":"98e70926.543948","name":"","x":1304.0000839233398,"y":415.7500810623169,"wires":[[]]},{"id":"c58e6d67.db875","type":"change","z":"98e70926.543948","name":"Set home assistant offline message","rules":[{"t":"set","p":"payload","pt":"msg","to":"(\t   $restarted := $flowContext(\"restarted\");\t   $notificationId := $restarted ? $flowContext(\"notificationId\") : msg.topic;\t   {\t       \"autoremote\":{\t           \"notification\":{\t               \"id\": $notificationId,\t               \"title\":\"Home Assistant\",\t               \"text\":$restarted ? \"Restarting\" : \"Offline\",\t               \"icon\":$restarted ? \"https://www.home-assistant.io/images/components/alexa/alexa-108x108.png\" : \"https://cdn2.iconfinder.com/data/icons/freecns-cumulus/32/519791-101_Warning-128.png\",\t               \"indeterminateprogress\": $restarted ? true : null\t           },\t           \"devices\":[\"brad\"]\t \t       }\t\t   }\t\t)","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":1054.0000839233398,"y":415.7500810623169,"wires":[["6e851f70.6d24a"]]},{"id":"f1d01ae2.4271a8","type":"subflow:8f5573e3.e52df","z":"98e70926.543948","name":"","x":1299.0000839233398,"y":246.7500810623169,"wires":[[]]},{"id":"412b7377.77d51c","type":"comment","z":"98e70926.543948","name":"Home assistant monitor","info":"","x":115.50008392333984,"y":270.7500810623169,"wires":[]},{"id":"62181223.1ff0fc","type":"comment","z":"98e70926.543948","name":"Home assistant online","info":"","x":750.5000839233398,"y":246.7500810623169,"wires":[]},{"id":"c98da19.af3726","type":"comment","z":"98e70926.543948","name":"AutoRemote","info":"","x":780.5000839233398,"y":285.7500810623169,"wires":[]},{"id":"4375922b.14a33c","type":"comment","z":"98e70926.543948","name":"Shelly update","info":"","x":780.5000839233398,"y":331.7500810623169,"wires":[]},{"id":"10261aa0.105e25","type":"mqtt out","z":"98e70926.543948","name":"Update shellies","topic":"shellies/command","qos":"0","retain":"false","broker":"ab404be4.584f18","x":1177.5000839233398,"y":330.7500810623169,"wires":[]},{"id":"92d3e50f.f48db8","type":"change","z":"98e70926.543948","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"update","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":991.5000839233398,"y":330.7500810623169,"wires":[["10261aa0.105e25"]]},{"id":"a62147c6.2ac208","type":"comment","z":"98e70926.543948","name":"Home assistant offline","info":"","x":750.0000839233398,"y":375.7500810623169,"wires":[]},{"id":"e6d3d7e4.e07368","type":"comment","z":"98e70926.543948","name":"AutoRemote","info":"","x":781.0000839233398,"y":415.7500810623169,"wires":[]},{"id":"fe37facc.60fd58","type":"link out","z":"98e70926.543948","name":"HASS online","links":["37e73b94.cbdf24","77e01aee.53c9c4","a694c7f4.abe498","1fa9db6a.744ce5"],"x":530.5000839233398,"y":289.7500810623169,"wires":[]},{"id":"6e7af992.aebe38","type":"link out","z":"98e70926.543948","name":"HASS offline","links":["62bd77df.ed9f48"],"x":530.5000839233398,"y":328.7500810623169,"wires":[]},{"id":"7bba1fd0.3c189","type":"comment","z":"98e70926.543948","name":"Online","info":"","x":600.0000839233398,"y":288.7500810623169,"wires":[]},{"id":"ca6cf3a1.04f25","type":"comment","z":"98e70926.543948","name":"Offline","info":"","x":601.0000839233398,"y":328.7500810623169,"wires":[]},{"id":"a694c7f4.abe498","type":"link in","z":"98e70926.543948","name":"HASS online AutoRemote","links":["fe37facc.60fd58"],"x":871.5000839233398,"y":284.7500810623169,"wires":[["b3056446.849858"]]},{"id":"1fa9db6a.744ce5","type":"link in","z":"98e70926.543948","name":"HASS online Shelly update","links":["fe37facc.60fd58"],"x":872.0000839233398,"y":330.7500810623169,"wires":[["92d3e50f.f48db8"]]},{"id":"62bd77df.ed9f48","type":"link in","z":"98e70926.543948","name":"HASS offline AutoRemote","links":["6e7af992.aebe38"],"x":873.0000839233398,"y":415.7500810623169,"wires":[["c58e6d67.db875"]]},{"id":"119104b2.ab794b","type":"mqtt out","z":"3e06a286.f1fcfe","name":"","topic":"shellies/shelly1-943C58/relay/0/command","qos":"0","retain":"false","broker":"ab404be4.584f18","x":377,"y":301,"wires":[]},{"id":"2113e6fd.a8312a","type":"inject","z":"3e06a286.f1fcfe","name":"","topic":"","payload":"on","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":109,"y":283,"wires":[["119104b2.ab794b"]]},{"id":"da18f77f.3b36c8","type":"inject","z":"3e06a286.f1fcfe","name":"","topic":"","payload":"off","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":108,"y":322,"wires":[["119104b2.ab794b"]]},{"id":"dc87f8cf.cb9578","type":"server-state-changed","z":"257e9eaf.a9d202","name":"MQTT Timestamp","server":"5806b60f.c2e778","entityidfilter":"sensor.brad_mobile_mqtt_send_timestamp","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"","halt_if_type":"str","halt_if_compare":"is","outputs":1,"output_only_on_state_change":true,"x":115.5,"y":769,"wires":[["dee4b35.eff6d5"]]},{"id":"dee4b35.eff6d5","type":"change","z":"257e9eaf.a9d202","name":"Set MQTT_RCV_TIMESTAMP to payload","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\t    \"taskerVariable\": {\t        \"name\": \"MQTT_RCV_TIMESTAMP\",\t        \"value\": payload,\t        \"devices\": [\"brad\"]\t    }\t}","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":393,"y":769,"wires":[["752fe7f.d1c7318"]]},{"id":"cc4dda7c.021558","type":"change","z":"12d32bdb.3c9804","name":"Set variable message","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\t   \"autoremote\":{\t       \"message\":{\t           \"message\": \"setvar \" & payload.taskerVariable.name & \"=:=\" & payload.taskerVariable.value,\t           \"collapseKey\": payload.taskerVariable.name\t       },\t       \"devices\": payload.taskerVariable.devices\t   }\t}","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":232,"y":68,"wires":[["565c25d.7e677dc"]]},{"id":"565c25d.7e677dc","type":"subflow:8f5573e3.e52df","z":"12d32bdb.3c9804","name":"","x":438.5,"y":68,"wires":[[]]},{"id":"752fe7f.d1c7318","type":"subflow:12d32bdb.3c9804","z":"257e9eaf.a9d202","name":"","x":674.5,"y":769,"wires":[[]]},{"id":"1cdfff07.0728b1","type":"change","z":"257e9eaf.a9d202","name":"Set INOFFICE to payload","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\t   \"taskerVariable\":{\t       \"name\":\"INOFFICE\",\t       \"value\":payload = \"on\" ? true : false,\t       \"devices\":[\"brad\"]\t   }\t}","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":540,"y":247,"wires":[["5b57ffb0.c0ff5"]]},{"id":"5b57ffb0.c0ff5","type":"subflow:12d32bdb.3c9804","z":"257e9eaf.a9d202","name":"","x":769,"y":247,"wires":[[]]},{"id":"4880d837.dfe3a8","type":"change","z":"257e9eaf.a9d202","name":"Extract door access code","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\t   \"data\":{\t        \"entity_id\": \"input_text.enable_door\",\t       \"value\":$match(payload, /\\d{4}E/).match\t   }\t}","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":192.5,"y":615,"wires":[["e5d00827.1add58"]]},{"id":"e5d00827.1add58","type":"api-call-service","z":"257e9eaf.a9d202","name":"Store door access code","server":"5806b60f.c2e778","service_domain":"input_text","service":"set_value","data":"","mergecontext":"","output_location":"payload","output_location_type":"msg","x":432.5,"y":615,"wires":[[]]},{"id":"a8a26d9b.4a055","type":"subflow:c26c68e9.a7fd88","z":"257e9eaf.a9d202","name":"","env":[],"x":1262,"y":490,"wires":[["128530b6.a7587f"]]},{"id":"d7804aa1.653658","type":"inject","z":"257e9eaf.a9d202","name":"On","topic":"","payload":"true","payloadType":"bool","repeat":"","crontab":"","once":true,"onceDelay":0.1,"x":85.5,"y":480,"wires":[["f42617e8.545b48"]]},{"id":"6a86d692.24d238","type":"inject","z":"257e9eaf.a9d202","name":"Off","topic":"","payload":"false","payloadType":"bool","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":86,"y":515,"wires":[["f42617e8.545b48"]]},{"id":"f42617e8.545b48","type":"change","z":"257e9eaf.a9d202","name":"Set update_enable_status","rules":[{"t":"set","p":"update_enable_status","pt":"global","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":270.5,"y":495,"wires":[["98e87584.c7e4c8"]]},{"id":"cbbb64af.32dd18","type":"switch","z":"c26c68e9.a7fd88","name":"Update enable status?","property":"update_enable_status","propertyType":"global","rules":[{"t":"true"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":145.5,"y":315,"wires":[["e47d55aa.5af588"],["4ccf8e7b.8482c"]]},{"id":"4ccf8e7b.8482c","type":"change","z":"c26c68e9.a7fd88","name":"set status response (503 - unavailable)","rules":[{"t":"set","p":"payload","pt":"msg","to":"503","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":616,"y":362,"wires":[[]]},{"id":"98e87584.c7e4c8","type":"debug","z":"257e9eaf.a9d202","name":"Enabled?","active":true,"tosidebar":false,"console":false,"tostatus":true,"complete":"payload","targetType":"msg","x":467.5,"y":495,"wires":[]},{"id":"2da1871e.f123b8","type":"e-mail in","z":"9943920f.042cc","name":"Receive emails from node-red folder","protocol":"IMAP","server":"outlook.office365.com","useSSL":true,"port":"993","box":"node-red","disposition":"Read","criteria":"UNSEEN","repeat":"900","fetch":"auto","inputs":0,"x":165,"y":123,"wires":[["1024b9c5.c7bdd6"]]},{"id":"1024b9c5.c7bdd6","type":"switch","z":"9943920f.042cc","name":"Subject","property":"topic","propertyType":"msg","rules":[{"t":"regex","v":"(door|access) (code)","vt":"str","case":true},{"t":"regex","v":"Draw Alert","vt":"str","case":true}],"checkall":"true","repair":false,"outputs":2,"x":409,"y":123,"wires":[["93f1b564.0e3898"],["f44e984d.7457b8"]],"outputLabels":["Door access codes","PickMyPostcode"]},{"id":"93f1b564.0e3898","type":"link out","z":"9943920f.042cc","name":"Recieved door access code email","links":["ccb51aef.783a38"],"x":569.5,"y":109,"wires":[]},{"id":"ccb51aef.783a38","type":"link in","z":"257e9eaf.a9d202","name":"Process door access code email","links":["93f1b564.0e3898"],"x":45.5,"y":615,"wires":[["4880d837.dfe3a8"]]},{"id":"8fe7e8e7.4577d8","type":"comment","z":"257e9eaf.a9d202","name":"Door access code","info":"","x":98,"y":574,"wires":[]},{"id":"9480a405.5bc4e8","type":"comment","z":"257e9eaf.a9d202","name":"Enable status","info":"","x":81,"y":437,"wires":[]},{"id":"27ccc027.359e9","type":"comment","z":"257e9eaf.a9d202","name":"MQTT timestamp","info":"","x":91,"y":724,"wires":[]},{"id":"fcdc9d50.17dc2","type":"comment","z":"257e9eaf.a9d202","name":"BTB HQ","info":"","x":68,"y":35,"wires":[]},{"id":"9da6293d.5d6f48","type":"server-state-changed","z":"257e9eaf.a9d202","name":"INOFFICE","server":"5806b60f.c2e778","entityidfilter":"sensor.brad_mobile_tasker_variable_inoffice","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"","halt_if_type":"str","halt_if_compare":"is","outputs":1,"output_only_on_state_change":true,"x":85.5,"y":267,"wires":[["761adb7d.2ac574"]]},{"id":"761adb7d.2ac574","type":"api-current-state","z":"257e9eaf.a9d202","name":"Check in office sensor","server":"5806b60f.c2e778","outputs":2,"halt_if":"payload","halt_if_type":"msg","halt_if_compare":"is","override_topic":false,"entity_id":"binary_sensor.brad_in_office","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":274,"y":267,"wires":[["1cdfff07.0728b1"],[]]},{"id":"1f5b4072.825fb","type":"http in","z":"6076e8bd.b0fe58","name":"","url":"/api/tado/hotwater","method":"get","upload":false,"swaggerDoc":"","x":133,"y":229,"wires":[["4dd2b039.fc86e"]]},{"id":"9f76374f.0a8258","type":"http request","z":"6076e8bd.b0fe58","name":"GET","method":"GET","ret":"obj","paytoqs":false,"url":"{{{tado.url}}}","tls":"","proxy":"","authType":"basic","x":797.5,"y":229,"wires":[["ba3aecb7.31d8a"]]},{"id":"4dd2b039.fc86e","type":"credentials","z":"6076e8bd.b0fe58","name":"Tado Credentials","props":[{"value":"tado.homeid","type":"msg"},{"value":"tado.username","type":"msg"},{"value":"tado.password","type":"msg"}],"x":350.5,"y":229,"wires":[["3587dec4.a9aad2"]]},{"id":"3587dec4.a9aad2","type":"change","z":"6076e8bd.b0fe58","name":"Get Hot Water State URL","rules":[{"t":"set","p":"tado.url","pt":"msg","to":"\"https://my.tado.com/api/v2/homes/\" & tado.homeid & \"/zones/\" & \"0/state\" & \"?username=\" & tado.username & \"&password=\" & tado.password","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":590.5,"y":229,"wires":[["9f76374f.0a8258"]]},{"id":"e400bcad.aafb2","type":"http response","z":"6076e8bd.b0fe58","name":"","statusCode":"","headers":{},"x":1148.5,"y":229,"wires":[]},{"id":"ba3aecb7.31d8a","type":"change","z":"6076e8bd.b0fe58","name":"Get Power","rules":[{"t":"set","p":"payload","pt":"msg","to":"payload.setting.power","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":968.5,"y":229,"wires":[["e400bcad.aafb2"]]},{"id":"1528abf3.7d4294","type":"http in","z":"6076e8bd.b0fe58","name":"","url":"/api/tado/hotwater","method":"put","upload":false,"swaggerDoc":"","x":132,"y":324,"wires":[["5c89e632.2d1078"]]},{"id":"5c89e632.2d1078","type":"credentials","z":"6076e8bd.b0fe58","name":"Tado Credentials","props":[{"value":"tado.homeid","type":"msg"},{"value":"tado.username","type":"msg"},{"value":"tado.password","type":"msg"}],"x":351,"y":324,"wires":[["8bf03ebd.7e056"]]},{"id":"49f42cb0.49c834","type":"change","z":"6076e8bd.b0fe58","name":"Put Hot Water State URL & payload","rules":[{"t":"set","p":"tado.url","pt":"msg","to":"\"https://my.tado.com/api/v2/homes/\" & tado.homeid & \"/zones/\" & \"0/overlay\" & \"?username=\" & tado.username & \"&password=\" & tado.password","tot":"jsonata"},{"t":"set","p":"payload","pt":"msg","to":"{\t    \"type\": \"MANUAL\",\t    \"setting\": {\t        \"type\": \"HOT_WATER\",\t        \"power\": \"ON\",\t        \"temperature\": null\t    },\t    \"termination\": {\t        \"type\": \"TADO_MODE\",\t        \"typeSkillBasedApp\": \"TADO_MODE\"\t    }\t}","tot":"jsonata"},{"t":"set","p":"method","pt":"msg","to":"PUT","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":779,"y":291,"wires":[["bfc56836.0f5e88"]]},{"id":"bfc56836.0f5e88","type":"http request","z":"6076e8bd.b0fe58","name":"request","method":"use","ret":"obj","paytoqs":false,"url":"{{{tado.url}}}","tls":"","proxy":"","authType":"basic","x":1047,"y":315,"wires":[["10e60ac0.6fc455"]]},{"id":"10e60ac0.6fc455","type":"http response","z":"6076e8bd.b0fe58","name":"","statusCode":"","headers":{},"x":1195,"y":315,"wires":[]},{"id":"8bf03ebd.7e056","type":"switch","z":"6076e8bd.b0fe58","name":"","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"ON","vt":"str"},{"t":"eq","v":"OFF","vt":"str"}],"checkall":"false","repair":false,"outputs":2,"x":532.5,"y":324,"wires":[["49f42cb0.49c834"],["2666cfae.daedf"]]},{"id":"2666cfae.daedf","type":"change","z":"6076e8bd.b0fe58","name":"Delete Hot Water Overlay URL","rules":[{"t":"set","p":"tado.url","pt":"msg","to":"\"https://my.tado.com/api/v2/homes/\" & tado.homeid & \"/zones/\" & \"0/overlay\" & \"?username=\" & tado.username & \"&password=\" & tado.password","tot":"jsonata"},{"t":"set","p":"method","pt":"msg","to":"DELETE","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":780,"y":347,"wires":[["bfc56836.0f5e88"]]},{"id":"84fa231c.8ef37","type":"server-state-changed","z":"6076e8bd.b0fe58","name":"Hot water timer","server":"5806b60f.c2e778","entityidfilter":"timer.hotwater","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"active,idle","halt_if_type":"str","halt_if_compare":"does_not_include","outputs":2,"output_only_on_state_change":true,"x":111.5,"y":131,"wires":[["ad495224.90b9a"],[]]},{"id":"348dcc4d.6b2574","type":"api-call-service","z":"6076e8bd.b0fe58","name":"Hotwater switch","server":"5806b60f.c2e778","service_domain":"switch","service":"","data":"{\"entity_id\":\"switch.hotwater\"}","mergecontext":"","output_location":"payload","output_location_type":"msg","x":487.5,"y":130.2699966430664,"wires":[[]]},{"id":"ad495224.90b9a","type":"change","z":"6076e8bd.b0fe58","name":"Set service call","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\t    \"service\": payload = \"active\" ? \"turn_on\" : \"turn_off\"\t}","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":301.5,"y":130,"wires":[["348dcc4d.6b2574"]]},{"id":"8e06ae2a.f3fb7","type":"comment","z":"6076e8bd.b0fe58","name":"Timer","info":"","x":62.5,"y":90,"wires":[]},{"id":"f8e45bba.6a8638","type":"comment","z":"6076e8bd.b0fe58","name":"API","info":"","x":64.5,"y":191,"wires":[]},{"id":"d38fbe26.bc9c8","type":"debug","z":"3e06a286.f1fcfe","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":447.5,"y":509,"wires":[]},{"id":"2274cbbb.7b4234","type":"time-range-switch","z":"3e06a286.f1fcfe","name":"","lat":"","lon":"","startTime":"22:50","endTime":"23:05","startOffset":0,"endOffset":0,"x":261.5,"y":509,"wires":[["d38fbe26.bc9c8"],[]]},{"id":"1d0da822.042668","type":"inject","z":"3e06a286.f1fcfe","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":80.5,"y":514,"wires":[["2274cbbb.7b4234"]]},{"id":"9aa22996.40e848","type":"mqtt in","z":"98e70926.543948","name":"zigbee2mqtt","topic":"zigbee2mqtt/+","qos":"0","datatype":"auto","broker":"ab404be4.584f18","x":75,"y":536.5001583099365,"wires":[["56599e1a.f7a3b"]]},{"id":"56599e1a.f7a3b","type":"json","z":"98e70926.543948","name":"","property":"payload","action":"","pretty":false,"x":239.5001220703125,"y":536.7501220703125,"wires":[["e21c93fe.7b26a"]]},{"id":"2b20f320.21bdac","type":"split","z":"98e70926.543948","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"key","x":540.2501220703125,"y":506.00018310546875,"wires":[["9911336a.a4e2d"]]},{"id":"b0040182.93fae","type":"mqtt out","z":"98e70926.543948","name":"","topic":"","qos":"","retain":"","broker":"ab404be4.584f18","x":878.5,"y":531,"wires":[]},{"id":"9911336a.a4e2d","type":"change","z":"98e70926.543948","name":"Set topic","rules":[{"t":"set","p":"topic","pt":"msg","to":"topic & '/' & key","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":727.5,"y":506,"wires":[["b0040182.93fae"]]},{"id":"eb048ad8.8f6688","type":"api-call-service","z":"98bf1f56.6da51","name":"Turn on hall light","server":"5806b60f.c2e778","service_domain":"light","service":"turn_on","data":"{\"entity_id\":\"light.hall\"}","mergecontext":"","output_location":"","output_location_type":"none","x":542,"y":467,"wires":[["4db58b2b.54a334"]]},{"id":"d900bef7.910d7","type":"api-call-service","z":"98bf1f56.6da51","name":"Turn off hall light","server":"5806b60f.c2e778","service_domain":"light","service":"turn_off","data":"{\"entity_id\":\"light.hall\"}","mergecontext":"","output_location":"","output_location_type":"none","x":1128,"y":530,"wires":[[]]},{"id":"6608b5a6.1c0fcc","type":"server-state-changed","z":"98bf1f56.6da51","name":"Hall Light Switch","server":"5806b60f.c2e778","entityidfilter":"binary_sensor.hall_light_switch","entityidfiltertype":"exact","outputinitially":false,"state_type":"habool","haltifstate":"","halt_if_type":"str","halt_if_compare":"is","outputs":1,"output_only_on_state_change":true,"x":314,"y":423,"wires":[["eb048ad8.8f6688"]]},{"id":"1ae1c9f0.9d5ae6","type":"mqtt out","z":"94dca4da.a92a08","name":"mqtt","topic":"","qos":"1","retain":"true","broker":"ab404be4.584f18","x":439.5,"y":53,"wires":[]},{"id":"620a2cff.9f70e4","type":"change","z":"94dca4da.a92a08","name":"Set payload","rules":[{"t":"set","p":"payload","pt":"msg","to":"(\t   $milliseconds := $millis() + payload * 1000;\t   $seconds := $substring($string($milliseconds), 0, 10);\t   {\t    \"triggerTimeSeconds\": $seconds,\t    \"responsePayload\": responsePayload\t   }\t)","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":218.5,"y":53,"wires":[["1ae1c9f0.9d5ae6"]]},{"id":"a064b7d1.f9a9d8","type":"mqtt in","z":"9f58257c.b55cc8","name":"zigbee2mqtt/out","topic":"zigbee2mqtt/bridge/networkmap/graphviz","qos":"2","datatype":"auto","broker":"ab404be4.584f18","x":120,"y":140,"wires":[["5a717adc.c378b4"]]},{"id":"6eb4f5bd.4c797c","type":"http in","z":"9f58257c.b55cc8","name":"","url":"/adminpanelapi/networkmap/graphviz","method":"get","upload":false,"swaggerDoc":"","x":200,"y":200,"wires":[["72ca12bd.e55ebc"]]},{"id":"c001d612.240ac8","type":"http response","z":"9f58257c.b55cc8","name":"","x":590,"y":200,"wires":[]},{"id":"72ca12bd.e55ebc","type":"function","z":"9f58257c.b55cc8","name":"get from flow","func":"var networkmap = flow.get('networkmap');\nmsg.payload = networkmap;\nreturn msg;","outputs":1,"noerr":0,"x":450,"y":200,"wires":[["c001d612.240ac8"]]},{"id":"a7053022.c3636","type":"inject","z":"9f58257c.b55cc8","name":"","topic":"","payload":"graphviz","payloadType":"str","repeat":"60","crontab":"","once":true,"onceDelay":0.1,"x":120,"y":80,"wires":[["a771c223.54908"]]},{"id":"5a717adc.c378b4","type":"function","z":"9f58257c.b55cc8","name":"store in flow","func":"flow.set('networkmap',msg.payload);\nreturn msg;","outputs":1,"noerr":0,"x":290,"y":140,"wires":[[]]},{"id":"a771c223.54908","type":"mqtt out","z":"9f58257c.b55cc8","name":"zigbee2mqtt/in","topic":"zigbee2mqtt/bridge/networkmap","qos":"","retain":"","broker":"ab404be4.584f18","x":280,"y":80,"wires":[]},{"id":"987cec36.d20a2","type":"mqtt in","z":"a13d547b.c3be08","name":"zigbee2mqtt/logging","topic":"zigbee2mqtt/bridge/log","qos":"2","datatype":"auto","broker":"ab404be4.584f18","x":290,"y":140,"wires":[["b13f530.a5e7cb"]]},{"id":"b13f530.a5e7cb","type":"json","z":"a13d547b.c3be08","name":"","property":"payload","action":"","pretty":false,"x":450,"y":140,"wires":[["fda55ccb.0374c","5dc64f8.25cdab","4168b62c.bf1458"]]},{"id":"95213fc2.77f8c","type":"ui_toast","z":"a13d547b.c3be08","position":"top right","displayTime":"30","highlight":"","outputs":0,"ok":"OK","cancel":"","topic":"System Notification","name":"","x":950,"y":80,"wires":[]},{"id":"fda55ccb.0374c","type":"function","z":"a13d547b.c3be08","name":"Notification","func":"if(msg.payload.type == \"pairing\" && msg.payload.message == \"connecting with device\") {\n\nmsg.payload = (\"A device is attempting to pair...\");\n\nreturn msg;\n}\n","outputs":1,"noerr":0,"x":750,"y":80,"wires":[["95213fc2.77f8c"]]},{"id":"83919489.ea3ae8","type":"comment","z":"a13d547b.c3be08","name":"Notification","info":"","x":110,"y":140,"wires":[]},{"id":"a84db8f.6ed6948","type":"comment","z":"a13d547b.c3be08","name":"Pairing","info":"","x":590,"y":80,"wires":[]},{"id":"19a72366.bffc6d","type":"ui_toast","z":"a13d547b.c3be08","position":"top right","displayTime":"10","highlight":"","outputs":0,"ok":"OK","cancel":"","topic":"System Notification","name":"","x":950,"y":200,"wires":[]},{"id":"5dc64f8.25cdab","type":"function","z":"a13d547b.c3be08","name":"Notification","func":"if(msg.payload.type == \"device_connected\") {\n\nmsg.payload = (\"Device paired successfully: \" + msg.payload.message);\n\nreturn msg;\n}\n","outputs":1,"noerr":0,"x":750,"y":200,"wires":[["19a72366.bffc6d"]]},{"id":"36f5d561.db40ca","type":"comment","z":"a13d547b.c3be08","name":"Paired","info":"","x":590,"y":200,"wires":[]},{"id":"a7e77e76.dd3","type":"ui_toast","z":"a13d547b.c3be08","position":"top right","displayTime":"30","highlight":"","outputs":0,"ok":"OK","cancel":"","topic":"System Notification","name":"","x":1030,"y":140,"wires":[]},{"id":"4168b62c.bf1458","type":"function","z":"a13d547b.c3be08","name":"Notification","func":"if(msg.payload.type == \"pairing\" && msg.payload.message == \"device incoming\") {\n\nmsg.payload = (\"A device is incoming or repairing...\");\n\nreturn msg;\n}\n","outputs":1,"noerr":0,"x":830,"y":140,"wires":[["a7e77e76.dd3"]]},{"id":"e0fb0faf.f330d","type":"comment","z":"a13d547b.c3be08","name":"Incoming or Repairing","info":"","x":640,"y":140,"wires":[]},{"id":"929a0f08.a46de","type":"mqtt in","z":"3db3968f.235e2a","name":"zigbee2mqtt/out devices","topic":"zigbee2mqtt/bridge/log","qos":"2","datatype":"auto","broker":"ab404be4.584f18","x":350,"y":140,"wires":[["ea3823ef.64fcf"]]},{"id":"f588eada.8181e8","type":"ui_template","z":"3db3968f.235e2a","group":"cd542645.b771b8","name":"","order":0,"width":"12","height":"12","format":"<table>\n<tr>\n    <td><B><U>Name:</U></B></td>\n    <td><B><U>ieeeAddr:</U></B></td>\n    <td><B><U>Model:</U></B></td>\n    <td><B><U>Type:</U></B></td>\n</tr>\n  <tr ng-repeat=\"obj in msg.payload.message\">\n    <td>{{ obj.friendly_name }}</td>\n    <td>{{ obj.ieeeAddr }}</td>\n    <td>{{ obj.model }}</td>\n    <td>{{ obj.type }}</td>\n  </tr>\n\n</table>\n\n","storeOutMessages":true,"fwdInMessages":true,"templateScope":"local","x":660,"y":140,"wires":[[]]},{"id":"eb3f0239.e06f3","type":"mqtt out","z":"3db3968f.235e2a","name":"zigbee2mqtt/in devices","topic":"zigbee2mqtt/bridge/config/devices","qos":"","retain":"","broker":"ab404be4.584f18","x":580,"y":60,"wires":[]},{"id":"655de5c9.a8423c","type":"inject","z":"3db3968f.235e2a","name":"Request Device List","topic":"","payload":"","payloadType":"date","repeat":"4","crontab":"","once":true,"onceDelay":0.1,"x":360,"y":60,"wires":[["eb3f0239.e06f3"]]},{"id":"170976d2.5c5529","type":"comment","z":"3db3968f.235e2a","name":"Request Device List","info":"","x":130,"y":60,"wires":[]},{"id":"9bbed4ce.3313f8","type":"comment","z":"3db3968f.235e2a","name":"Receive Device List","info":"","x":130,"y":140,"wires":[]},{"id":"ea3823ef.64fcf","type":"json","z":"3db3968f.235e2a","name":"","property":"payload","action":"","pretty":false,"x":530,"y":140,"wires":[["f588eada.8181e8","c235e87a.f614a8","eff40f0d.e9091"]]},{"id":"b31600e8.d5a72","type":"http in","z":"3db3968f.235e2a","name":"","url":"/adminpanelapi/devicelist","method":"get","upload":false,"swaggerDoc":"","x":530,"y":220,"wires":[["9488776b.edd088"]]},{"id":"c235e87a.f614a8","type":"function","z":"3db3968f.235e2a","name":"Store Data","func":"flow.set('devicelist',msg.payload);","outputs":1,"noerr":0,"x":310,"y":220,"wires":[[]]},{"id":"9d683c7e.346d1","type":"http response","z":"3db3968f.235e2a","name":"","x":870,"y":220,"wires":[]},{"id":"9488776b.edd088","type":"function","z":"3db3968f.235e2a","name":"Get Data","func":"var devicelist = flow.get('devicelist');\nmsg.payload = devicelist;\nreturn msg;","outputs":1,"noerr":0,"x":740,"y":220,"wires":[["9d683c7e.346d1"]]},{"id":"b3111e85.a6062","type":"comment","z":"3db3968f.235e2a","name":"HTTP JSON API","info":"","x":120,"y":220,"wires":[]},{"id":"eff40f0d.e9091","type":"function","z":"3db3968f.235e2a","name":"Store Globally","func":"global.set('zigbee2mqttdevicelist',msg.payload.message);\nreturn msg;","outputs":1,"noerr":0,"x":890,"y":120,"wires":[[]]},{"id":"fd582bda.388e18","type":"mqtt in","z":"e0298c5b.a16c5","name":"zigbee2mqtt/bridge state","topic":"zigbee2mqtt/bridge/state","qos":"2","datatype":"auto","broker":"ab404be4.584f18","x":270,"y":80,"wires":[["90f72cdd.facd"]]},{"id":"90f72cdd.facd","type":"function","z":"e0298c5b.a16c5","name":"Format Data","func":"flow.set('bridgestate',msg.payload);\nvar bridgestate = flow.get('bridgestate');\nmsg.payload = bridgestate;\nreturn msg;","outputs":1,"noerr":0,"x":470,"y":80,"wires":[["5166f03b.c8517"]]},{"id":"c633511a.1e9b6","type":"ui_template","z":"e0298c5b.a16c5","group":"6aef0367.061cac","name":"","order":0,"width":"6","height":"2","format":"<style>\n    {{msg.style}}\n</style>\n\n<table>\n  <tr>\n    <td>Bridge</td>\n    <td>{{msg.payload.bridgestate}}</td>\n  </tr>\n  <tr>\n    <td>Devices</td>\n    <td>{{msg.payload.numberofdevices}}</td>\n  </tr>\n</table>","storeOutMessages":true,"fwdInMessages":true,"templateScope":"local","x":660,"y":140,"wires":[[]]},{"id":"67934b2e.e3d2b4","type":"function","z":"e0298c5b.a16c5","name":"Format Data","func":"var bridgestate = flow.get('bridgestate');\nvar devicelist = global.get('zigbee2mqttdevicelist');\nmsg.payload = {}\nmsg.payload.bridgestate = bridgestate;\nmsg.payload.numberofdevices = devicelist.length;\n\nreturn msg;","outputs":1,"noerr":0,"x":510,"y":140,"wires":[["c633511a.1e9b6"]]},{"id":"23cc3d24.6cea82","type":"inject","z":"e0298c5b.a16c5","name":"","topic":"","payload":"","payloadType":"date","repeat":"3","crontab":"","once":true,"onceDelay":0.1,"x":350,"y":140,"wires":[["67934b2e.e3d2b4"]]},{"id":"5166f03b.c8517","type":"debug","z":"e0298c5b.a16c5","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":610,"y":80,"wires":[]},{"id":"bc3e5b32.27a238","type":"comment","z":"e0298c5b.a16c5","name":"Get state","info":"","x":80,"y":80,"wires":[]},{"id":"71f04dc.bd2e9b4","type":"comment","z":"e0298c5b.a16c5","name":"Update Web UI on Interval","info":"","x":130,"y":140,"wires":[]},{"id":"c9a64a6b.cb5448","type":"http in","z":"e0298c5b.a16c5","name":"","url":"/adminpanelapi/state","method":"get","upload":false,"swaggerDoc":"","x":270,"y":220,"wires":[["ae91249c.4642b8"]]},{"id":"6a509843.8bae28","type":"http response","z":"e0298c5b.a16c5","name":"","x":590,"y":220,"wires":[]},{"id":"ae91249c.4642b8","type":"function","z":"e0298c5b.a16c5","name":"Get Data","func":"var bridgestate = flow.get('bridgestate');\nmsg.payload = bridgestate;\nreturn msg;","outputs":1,"noerr":0,"x":460,"y":220,"wires":[["6a509843.8bae28"]]},{"id":"a6134e60.5b54e","type":"comment","z":"e0298c5b.a16c5","name":"HTTP API","info":"","x":80,"y":220,"wires":[]},{"id":"88dce856.0e3288","type":"ui_dropdown","z":"985d4e07.a55e2","name":"","label":"","place":"Select option","group":"795ffc67.304ee4","order":1,"width":0,"height":0,"passthru":true,"options":[{"label":"Info","value":"info","type":"str"},{"label":"Debug","value":"debug","type":"str"},{"label":"Warn","value":"warn","type":"str"},{"label":"Error","value":"error","type":"str"}],"payload":"","topic":"","x":120,"y":60,"wires":[["8de04975.8daf08"]]},{"id":"8de04975.8daf08","type":"mqtt out","z":"985d4e07.a55e2","name":"zigbee2mqtt/in Logging Level","topic":"zigbee2mqtt/bridge/config/log_level","qos":"","retain":"","broker":"ab404be4.584f18","x":380,"y":60,"wires":[]},{"id":"1a9a8a48.21feb6","type":"ui_text_input","z":"6598b10d.6ea72","name":"","label":"Device Name","group":"5fdce667.2f2e18","order":3,"width":0,"height":0,"passthru":true,"mode":"text","delay":"5","topic":"","x":300,"y":60,"wires":[["e33d1f4c.1247"]]},{"id":"13c560ca.84f30f","type":"mqtt out","z":"6598b10d.6ea72","name":"zigbee2mqtt/in Remove","topic":"zigbee2mqtt/bridge/config/remove","qos":"","retain":"","broker":"ab404be4.584f18","x":1190,"y":60,"wires":[]},{"id":"16cf75b8.2b8b0a","type":"function","z":"6598b10d.6ea72","name":"Format Data","func":"flow.set('remove',msg.payload.remove);","outputs":1,"noerr":0,"x":650,"y":60,"wires":[[]]},{"id":"e33d1f4c.1247","type":"change","z":"6598b10d.6ea72","name":"change msg old","rules":[{"t":"move","p":"payload","pt":"msg","to":"payload.remove","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":480,"y":60,"wires":[["16cf75b8.2b8b0a"]]},{"id":"6e4beb55.3283c4","type":"function","z":"6598b10d.6ea72","name":"Format Data","func":"var remove = flow.get('remove');\nif (typeof remove !== 'undefined' && remove !== null && remove !== \"\"){\nmsg.payload = remove;\n\nreturn msg;\n}","outputs":1,"noerr":0,"x":970,"y":60,"wires":[["13c560ca.84f30f"]]},{"id":"e874e552.40d648","type":"ui_button","z":"6598b10d.6ea72","name":"","group":"5fdce667.2f2e18","order":5,"width":0,"height":0,"passthru":false,"label":"Remove","color":"","bgcolor":"","icon":"","payload":"","payloadType":"date","topic":"","x":820,"y":60,"wires":[["6e4beb55.3283c4","89f9c8f9.7e0ea8"]]},{"id":"acce781d.4a13d8","type":"comment","z":"6598b10d.6ea72","name":"Remove Device","info":"","x":120,"y":60,"wires":[]},{"id":"6c18e830.406758","type":"mqtt in","z":"6598b10d.6ea72","name":"zigbee2mqtt/logging","topic":"zigbee2mqtt/bridge/log","qos":"2","datatype":"auto","broker":"ab404be4.584f18","x":290,"y":120,"wires":[["8cdd82e9.3f1de"]]},{"id":"8cdd82e9.3f1de","type":"json","z":"6598b10d.6ea72","name":"","property":"payload","action":"","pretty":false,"x":450,"y":120,"wires":[["a7fef321.ed1ae"]]},{"id":"bb4bd3da.06522","type":"ui_toast","z":"6598b10d.6ea72","position":"top right","displayTime":"5","highlight":"","outputs":0,"ok":"OK","cancel":"","topic":"System Notification","name":"","x":790,"y":120,"wires":[]},{"id":"a7fef321.ed1ae","type":"function","z":"6598b10d.6ea72","name":"Notification","func":"if(msg.payload.type == 'device_removed') {\nvar remove = flow.get('remove');\nif (typeof remove !== 'undefined' && remove !== null && remove !== \"\"){\nmsg.payload = (\"Deviced removed: \" + msg.payload.message);\n\n// Reset field\n//remove = \"\";\n//flow.set('remove',msg.payload.message);\n\nreturn msg;\n}\n}\n\n","outputs":1,"noerr":0,"x":590,"y":120,"wires":[["bb4bd3da.06522"]]},{"id":"de390403.2406e8","type":"comment","z":"6598b10d.6ea72","name":"Notification","info":"","x":110,"y":120,"wires":[]},{"id":"69b69a7c.5e2714","type":"ui_toast","z":"6598b10d.6ea72","position":"top right","displayTime":"5","highlight":"","outputs":0,"ok":"OK","cancel":"","topic":"System Notification","name":"","x":1210,"y":120,"wires":[]},{"id":"89f9c8f9.7e0ea8","type":"function","z":"6598b10d.6ea72","name":"Notification","func":"var remove = flow.get('remove');\nif (typeof remove === 'undefined' || remove === null || remove === \"\"){\nmsg.payload = \"Enter a device to remove\";\n\nreturn msg;\n}","outputs":1,"noerr":0,"x":1010,"y":120,"wires":[["69b69a7c.5e2714"]]},{"id":"dd2ebee2.b499f","type":"ui_dropdown","z":"db3d1c60.309a3","name":"","label":"","place":"Select option","group":"88e9fbfc.45f488","order":1,"width":0,"height":0,"passthru":true,"options":[{"label":"Allow","value":"true","type":"str"},{"label":"Deny","value":"false","type":"str"}],"payload":"","topic":"","x":90,"y":40,"wires":[["d2303d5c.5ca3","2aaaf0a9.8753b"]]},{"id":"d2303d5c.5ca3","type":"mqtt out","z":"db3d1c60.309a3","name":"zigbee2mqtt/in Join","topic":"zigbee2mqtt/bridge/config/permit_join","qos":"","retain":"","broker":"ab404be4.584f18","x":270,"y":40,"wires":[]},{"id":"4db27e24.989b1","type":"ui_toast","z":"db3d1c60.309a3","position":"top right","displayTime":"5","highlight":"","outputs":0,"ok":"OK","cancel":"","topic":"System Notification","name":"","x":450,"y":100,"wires":[]},{"id":"2aaaf0a9.8753b","type":"function","z":"db3d1c60.309a3","name":"Notification","func":"if (typeof msg.payload !== 'undefined' && msg.payload !== null && msg.payload !== \"\"){\nif (msg.payload == \"false\"){\n    msg.payload = \"Permit join: Deny\";\n}\nif (msg.payload == \"true\"){\n    msg.payload = \"Permit join: Allow\";\n}\nreturn msg;\n}\n","outputs":1,"noerr":0,"x":250,"y":100,"wires":[["4db27e24.989b1"]]},{"id":"cd3d7aa7.971c28","type":"ui_text_input","z":"f72bc520.d84698","name":"","label":"Old Name","group":"8319e184.2e15a","order":3,"width":0,"height":0,"passthru":true,"mode":"text","delay":"5","topic":"","x":120,"y":140,"wires":[["b90c1bea.18b778"]]},{"id":"dcddac84.ffadd","type":"ui_text_input","z":"f72bc520.d84698","name":"","label":"New Name","group":"8319e184.2e15a","order":4,"width":0,"height":0,"passthru":true,"mode":"text","delay":"5","topic":"","x":130,"y":200,"wires":[["68fdee0.914c214"]]},{"id":"e68a602a.f13b3","type":"mqtt out","z":"f72bc520.d84698","name":"zigbee2mqtt/in Rename","topic":"zigbee2mqtt/bridge/config/rename","qos":"","retain":"","broker":"ab404be4.584f18","x":1010,"y":140,"wires":[]},{"id":"cb3a47f7.6a6cc8","type":"function","z":"f72bc520.d84698","name":"Format Data","func":"flow.set('oldname',msg.payload.old);","outputs":1,"noerr":0,"x":470,"y":140,"wires":[[]]},{"id":"b90c1bea.18b778","type":"change","z":"f72bc520.d84698","name":"change msg old","rules":[{"t":"move","p":"payload","pt":"msg","to":"payload.old","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":300,"y":140,"wires":[["cb3a47f7.6a6cc8"]]},{"id":"68fdee0.914c214","type":"change","z":"f72bc520.d84698","name":"change msg new","rules":[{"t":"move","p":"payload","pt":"msg","to":"payload.new","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":310,"y":200,"wires":[["bdccadee.5db22"]]},{"id":"5a57ff5a.1f9ae","type":"function","z":"f72bc520.d84698","name":"Format Data","func":"var oldname = flow.get('oldname');\nvar newname = flow.get('newname');\n\nif (typeof oldname !== 'undefined' && oldname !== null && oldname !== \"\" && typeof newname !== 'undefined' && newname !== null && newname !== \"\"){\nmsg.payload = {\"old\": oldname, \"new\": newname}\n\n// Reset fields\noldname = \"\";\nnewname = \"\";\nflow.set('oldname',msg.payload.old);\nflow.set('newname',msg.payload.new);\n\nreturn msg;\n}","outputs":1,"noerr":0,"x":790,"y":140,"wires":[["e68a602a.f13b3"]]},{"id":"bdccadee.5db22","type":"function","z":"f72bc520.d84698","name":"Format Data","func":"flow.set('newname',msg.payload.new);","outputs":1,"noerr":0,"x":490,"y":200,"wires":[[]]},{"id":"3c956c84.b6db24","type":"ui_button","z":"f72bc520.d84698","name":"","group":"8319e184.2e15a","order":5,"width":0,"height":0,"passthru":false,"label":"Rename","color":"","bgcolor":"","icon":"","payload":"","payloadType":"date","topic":"","x":640,"y":140,"wires":[["5a57ff5a.1f9ae","ea96b14.5ab185"]]},{"id":"883c08cf.913748","type":"ui_toast","z":"f72bc520.d84698","position":"top right","displayTime":"5","highlight":"","outputs":0,"ok":"OK","cancel":"","topic":"System Notification","name":"","x":850,"y":200,"wires":[]},{"id":"ea96b14.5ab185","type":"function","z":"f72bc520.d84698","name":"Notification","func":"var oldname = flow.get('oldname');\nvar newname = flow.get('newname');\n\nif (typeof oldname !== 'undefined' && oldname !== null && oldname !== \"\" && typeof newname !== 'undefined' && newname !== null && newname !== \"\"){\nmsg.payload = (\"Rename Device: \" + oldname + \" to \" + newname);\nreturn msg;\n} else {\nmsg.payload = \"Enter device to rename\";\nreturn msg;\n}\n","outputs":1,"noerr":0,"x":670,"y":200,"wires":[["883c08cf.913748"]]},{"id":"70560896.4c0098","type":"subflow:f72bc520.d84698","z":"2340bc28.5813f4","name":"","env":[],"x":159,"y":159,"wires":[]},{"id":"66d4baf5.8b2be4","type":"subflow:db3d1c60.309a3","z":"2340bc28.5813f4","name":"","env":[],"x":139,"y":119,"wires":[]},{"id":"bde1c3f8.aa097","type":"subflow:6598b10d.6ea72","z":"2340bc28.5813f4","name":"","env":[],"x":159,"y":199,"wires":[]},{"id":"dddddd21.d09a5","type":"comment","z":"2340bc28.5813f4","name":"Function","info":"","x":139,"y":79,"wires":[]},{"id":"1d61963f.e3a57a","type":"subflow:985d4e07.a55e2","z":"2340bc28.5813f4","name":"","env":[],"x":149,"y":239,"wires":[]},{"id":"e5211a83.498f38","type":"subflow:e0298c5b.a16c5","z":"2340bc28.5813f4","name":"","env":[],"x":129,"y":279,"wires":[]},{"id":"e46ee0c3.13b7a","type":"subflow:3db3968f.235e2a","z":"2340bc28.5813f4","name":"","env":[],"x":129,"y":319,"wires":[]},{"id":"3ad641bc.82410e","type":"comment","z":"2340bc28.5813f4","name":"Other","info":"","x":389,"y":79,"wires":[]},{"id":"f40a218e.26d84","type":"subflow:a13d547b.c3be08","z":"2340bc28.5813f4","name":"","env":[],"x":429,"y":119,"wires":[]},{"id":"f01a1e7c.8a6c5","type":"subflow:9f58257c.b55cc8","z":"2340bc28.5813f4","name":"","env":[],"x":409,"y":159,"wires":[]},{"id":"87e1795a.480eb8","type":"server-state-changed","z":"98bf1f56.6da51","name":"Hall Motion 1 trigger","server":"5806b60f.c2e778","entityidfilter":"binary_sensor.hall_motion_1_occupancy","entityidfiltertype":"exact","outputinitially":false,"state_type":"habool","haltifstate":"false","halt_if_type":"bool","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"x":133,"y":474,"wires":[["daac813b.42161"],[]]},{"id":"daac813b.42161","type":"api-current-state","z":"98bf1f56.6da51","name":"Illuminance","server":"5806b60f.c2e778","outputs":2,"halt_if":"16","halt_if_type":"num","halt_if_compare":"gte","override_topic":false,"entity_id":"sensor.hall_motion_1_illuminance","state_type":"num","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":322,"y":474,"wires":[["eb048ad8.8f6688"],["f865e99.4b67a18"]]},{"id":"3049e4ac.5cabac","type":"server-state-changed","z":"98bf1f56.6da51","name":"Hall Motion 2 trigger","server":"5806b60f.c2e778","entityidfilter":"binary_sensor.hall_motion_2_occupancy","entityidfiltertype":"exact","outputinitially":false,"state_type":"habool","haltifstate":"false","halt_if_type":"bool","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"x":132,"y":529,"wires":[["6a29b5c0.38e9dc"],[]]},{"id":"6a29b5c0.38e9dc","type":"api-current-state","z":"98bf1f56.6da51","name":"Illuminance","server":"5806b60f.c2e778","outputs":2,"halt_if":"9","halt_if_type":"num","halt_if_compare":"gte","override_topic":false,"entity_id":"sensor.hall_motion_2_illuminance","state_type":"num","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":321,"y":528,"wires":[["eb048ad8.8f6688"],["f865e99.4b67a18"]]},{"id":"36edf93c.9b5426","type":"server-state-changed","z":"98bf1f56.6da51","name":"Sun","server":"5806b60f.c2e778","entityidfilter":"sun.sun","entityidfiltertype":"exact","outputinitially":true,"state_type":"str","haltifstate":"","halt_if_type":"str","halt_if_compare":"is","outputs":1,"output_only_on_state_change":true,"x":1066.5,"y":1397,"wires":[[]]},{"id":"a10fce59.539a2","type":"switch","z":"98bf1f56.6da51","name":"","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"below_horizon","vt":"str"},{"t":"eq","v":"above_horizon","vt":"str"}],"checkall":"false","repair":false,"outputs":2,"x":1202.5,"y":1397,"wires":[["b652def.f49902"],[]],"outputLabels":["below_horizon","above_horizon"]},{"id":"b652def.f49902","type":"api-call-service","z":"98bf1f56.6da51","name":"Turn on sign light","server":"5806b60f.c2e778","service_domain":"light","service":"turn_on","data":"{\"entity_id\":\"light.sign\",\"brightness_pct\":75}","mergecontext":"","output_location":"","output_location_type":"none","x":1376,"y":1373,"wires":[[]]},{"id":"e4568621.78c058","type":"api-call-service","z":"98bf1f56.6da51","name":"Turn off sign light","server":"5806b60f.c2e778","service_domain":"light","service":"turn_off","data":"{\"entity_id\":\"light.sign\",\"transition\":15}","mergecontext":"","output_location":"","output_location_type":"none","x":565,"y":969,"wires":[["d8a88d08.cb456"]]},{"id":"4383983c.528db8","type":"server-state-changed","z":"98bf1f56.6da51","name":"Hall Motion 3 trigger","server":"5806b60f.c2e778","entityidfilter":"binary_sensor.hall_motion_3_occupancy","entityidfiltertype":"exact","outputinitially":false,"state_type":"habool","haltifstate":"false","halt_if_type":"bool","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"x":131,"y":581,"wires":[["be38fe16.9d13f"],[]]},{"id":"be38fe16.9d13f","type":"api-current-state","z":"98bf1f56.6da51","name":"Illuminance","server":"5806b60f.c2e778","outputs":2,"halt_if":"16","halt_if_type":"num","halt_if_compare":"gte","override_topic":false,"entity_id":"sensor.hall_motion_3_illuminance","state_type":"num","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":321,"y":579,"wires":[["eb048ad8.8f6688"],["f865e99.4b67a18"]]},{"id":"f865e99.4b67a18","type":"api-current-state","z":"98bf1f56.6da51","name":"Light on?","server":"5806b60f.c2e778","outputs":2,"halt_if":"false","halt_if_type":"bool","halt_if_compare":"is","override_topic":false,"entity_id":"light.hall","state_type":"habool","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":565,"y":535,"wires":[["4db58b2b.54a334"],[]]},{"id":"4db58b2b.54a334","type":"change","z":"98bf1f56.6da51","name":"hall_light timer: 2.5min","rules":[{"t":"set","p":"payload","pt":"msg","to":"150","tot":"json"},{"t":"set","p":"topic","pt":"msg","to":"mqtttimer/hall_light/start","tot":"str"},{"t":"set","p":"responsePayload","pt":"msg","to":"off","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":797.5,"y":467,"wires":[["87287e27.4ed88"]]},{"id":"87287e27.4ed88","type":"subflow:94dca4da.a92a08","z":"98bf1f56.6da51","name":"Start timer","env":[],"x":1039.5,"y":467,"wires":[]},{"id":"8edcc373.b9603","type":"mqtt in","z":"98bf1f56.6da51","name":"","topic":"mqtttimer/hall_light","qos":"1","datatype":"auto","broker":"ab404be4.584f18","x":787.5,"y":530,"wires":[["edd43eff.7dce8"]]},{"id":"c98f0e6e.4ab44","type":"inject","z":"98bf1f56.6da51","name":"8pm-midnight - Randomise hall lights","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"*/10 20-23 * * *","once":false,"onceDelay":0.1,"x":454.5,"y":304,"wires":[[]]},{"id":"786657f.803f5a8","type":"api-current-state","z":"98bf1f56.6da51","name":"Light on?","server":"5806b60f.c2e778","outputs":2,"halt_if":"true","halt_if_type":"bool","halt_if_compare":"is","override_topic":false,"entity_id":"light.hall","state_type":"habool","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":701,"y":304,"wires":[["ef3b8c77.5d94f"],[]]},{"id":"ef3b8c77.5d94f","type":"random","z":"98bf1f56.6da51","name":"Random - 60s - 1000s","low":"60","high":"1000","inte":"true","property":"payload","x":890.5,"y":304,"wires":[["ce177bd0.0bb518"]]},{"id":"ce177bd0.0bb518","type":"change","z":"98bf1f56.6da51","name":"hall_light timer","rules":[{"t":"set","p":"topic","pt":"msg","to":"mqtttimer/hall_light/start","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1109,"y":304,"wires":[["87287e27.4ed88","9119ece0.dff89"]]},{"id":"8e327eca.45a9b","type":"api-call-service","z":"98bf1f56.6da51","name":"Turn on canopy light","server":"5806b60f.c2e778","service_domain":"light","service":"turn_on","data":"{\"entity_id\":\"light.canopy_group\",\"brightness\":60,\"transition\":15}","mergecontext":"","output_location":"","output_location_type":"none","x":1182,"y":944,"wires":[["1de2b0e0.de6f4f"]]},{"id":"1de2b0e0.de6f4f","type":"api-call-service","z":"98bf1f56.6da51","name":"Turn on porch light","server":"5806b60f.c2e778","service_domain":"light","service":"turn_on","data":"{\"entity_id\":\"light.porch_group\",\"brightness\":60,\"transition\":15}","mergecontext":"","output_location":"","output_location_type":"none","x":1400,"y":944,"wires":[[]]},{"id":"7ebe08cc.e5c128","type":"inject","z":"98bf1f56.6da51","name":"10:30pm","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"30 22 * * *","once":false,"onceDelay":0.1,"x":158.5,"y":1051,"wires":[["84337193.ebef9"]]},{"id":"986e3476.9915c8","type":"api-call-service","z":"98bf1f56.6da51","name":"Turn off canopy light","server":"5806b60f.c2e778","service_domain":"light","service":"turn_off","data":"{\"entity_id\":\"light.canopy_group\",\"transition\":15}","mergecontext":"","output_location":"","output_location_type":"none","x":1183,"y":889,"wires":[["c12575b6.125908"]]},{"id":"c12575b6.125908","type":"api-call-service","z":"98bf1f56.6da51","name":"Turn off porch light","server":"5806b60f.c2e778","service_domain":"light","service":"turn_off","data":"{\"entity_id\":\"light.porch_group\",\"transition\":15}","mergecontext":"","output_location":"","output_location_type":"none","x":1399,"y":889,"wires":[[]]},{"id":"9119ece0.dff89","type":"api-call-service","z":"98bf1f56.6da51","name":"Turn on hall light","server":"5806b60f.c2e778","service_domain":"light","service":"turn_on","data":"{\"entity_id\":\"light.hall\"}","mergecontext":"","output_location":"","output_location_type":"none","x":1328,"y":305,"wires":[[]]},{"id":"43bc8f94.29cfd","type":"server-state-changed","z":"98bf1f56.6da51","name":"Utility motion trigger","server":"5806b60f.c2e778","entityidfilter":"binary_sensor.utility_motion_occupancy","entityidfiltertype":"exact","outputinitially":false,"state_type":"habool","haltifstate":"false","halt_if_type":"bool","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"x":518,"y":1308,"wires":[[],[]]},{"id":"45a76dd5.3cc0d4","type":"api-call-service","z":"98bf1f56.6da51","name":"Toggle utility light","server":"5806b60f.c2e778","service_domain":"light","service":"toggle","data":"{\"entity_id\":\"light.utility\"}","mergecontext":"","output_location":"","output_location_type":"none","x":717,"y":1306,"wires":[["ed146aa3.2ed6b8"]]},{"id":"ed146aa3.2ed6b8","type":"delay","z":"98bf1f56.6da51","name":"","pauseType":"delay","timeout":"250","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":904,"y":1303,"wires":[["7771db2.882fe24"]]},{"id":"7771db2.882fe24","type":"api-call-service","z":"98bf1f56.6da51","name":"Toggle utility light","server":"5806b60f.c2e778","service_domain":"light","service":"toggle","data":"{\"entity_id\":\"light.utility\"}","mergecontext":"","output_location":"","output_location_type":"none","x":1093,"y":1306,"wires":[[]]},{"id":"5f772d7d.df8744","type":"server-state-changed","z":"98bf1f56.6da51","name":"Utility motion trigger","server":"5806b60f.c2e778","entityidfilter":"binary_sensor.utility_motion_occupancy","entityidfiltertype":"exact","outputinitially":false,"state_type":"habool","haltifstate":"false","halt_if_type":"bool","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"x":131,"y":731,"wires":[["faef63c6.8f91b"],[]]},{"id":"faef63c6.8f91b","type":"api-current-state","z":"98bf1f56.6da51","name":"Illuminance","server":"5806b60f.c2e778","outputs":2,"halt_if":"16","halt_if_type":"num","halt_if_compare":"gte","override_topic":false,"entity_id":"sensor.utility_motion_illuminance","state_type":"num","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":321,"y":729,"wires":[["f30bc5e2.0b0508"],["e1bc81b2.e915d"]]},{"id":"f30bc5e2.0b0508","type":"api-call-service","z":"98bf1f56.6da51","name":"Turn on utility light","server":"5806b60f.c2e778","service_domain":"light","service":"turn_on","data":"{\"entity_id\":\"light.utility_group\"}","mergecontext":"","output_location":"","output_location_type":"none","x":518,"y":705,"wires":[["13ec566e.1a744a"]]},{"id":"e1bc81b2.e915d","type":"api-current-state","z":"98bf1f56.6da51","name":"Light on?","server":"5806b60f.c2e778","outputs":2,"halt_if":"false","halt_if_type":"bool","halt_if_compare":"is","override_topic":false,"entity_id":"light.utility","state_type":"habool","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":516,"y":755,"wires":[["13ec566e.1a744a"],[]]},{"id":"13ec566e.1a744a","type":"change","z":"98bf1f56.6da51","name":"utility_light timer: 2.5min","rules":[{"t":"set","p":"payload","pt":"msg","to":"150","tot":"json"},{"t":"set","p":"topic","pt":"msg","to":"mqtttimer/utility_light/start","tot":"str"},{"t":"set","p":"responsePayload","pt":"msg","to":"off","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":817,"y":679,"wires":[["f1faedd.7c0c61","42844648.61be88"]]},{"id":"f1faedd.7c0c61","type":"subflow:94dca4da.a92a08","z":"98bf1f56.6da51","name":"Start timer","env":[],"x":1043,"y":679,"wires":[]},{"id":"32f6b23a.3b6fde","type":"api-call-service","z":"98bf1f56.6da51","name":"Turn off utility light","server":"5806b60f.c2e778","service_domain":"light","service":"turn_off","data":"{\"entity_id\":\"light.utility_group\"}","mergecontext":"","output_location":"","output_location_type":"none","x":1245,"y":776,"wires":[[]]},{"id":"e3d3fddc.648bd","type":"mqtt in","z":"98bf1f56.6da51","name":"","topic":"mqtttimer/utility_light","qos":"1","datatype":"auto","broker":"ab404be4.584f18","x":704.5,"y":776,"wires":[["70620d7c.3a2f54"]]},{"id":"f9fc80e6.dc89f","type":"comment","z":"98bf1f56.6da51","name":"Hall lights","info":"","x":74,"y":421,"wires":[]},{"id":"25c319.526a4ce8","type":"comment","z":"98bf1f56.6da51","name":"Utility lights","info":"","x":81,"y":675,"wires":[]},{"id":"217394d2.4a1e1c","type":"change","z":"257e9eaf.a9d202","name":"Set DOOR_CODE to payload","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\t   \"taskerVariable\":{\t       \"name\":\"DOOR_CODE\",\t       \"value\":payload,\t       \"devices\":[\"brad\"]\t   }\t}","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":878,"y":638,"wires":[["be65aacf.e1e2e8"]]},{"id":"be65aacf.e1e2e8","type":"subflow:12d32bdb.3c9804","z":"257e9eaf.a9d202","name":"","x":1133,"y":638,"wires":[[]]},{"id":"7cbb328b.48980c","type":"server-state-changed","z":"257e9eaf.a9d202","name":"enable_door","server":"5806b60f.c2e778","entityidfilter":"input_text.enable_door","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"","halt_if_type":"str","halt_if_compare":"is","outputs":1,"output_only_on_state_change":true,"x":642,"y":614,"wires":[["217394d2.4a1e1c"]]},{"id":"ddafd472.c74478","type":"server-state-changed","z":"257e9eaf.a9d202","name":"DOOR_CODE","server":"5806b60f.c2e778","entityidfilter":"sensor.brad_mobile_tasker_variable_door_code","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"","halt_if_type":"str","halt_if_compare":"is","outputs":1,"output_only_on_state_change":true,"x":392,"y":674,"wires":[["397abd15.42ce42"]]},{"id":"397abd15.42ce42","type":"api-current-state","z":"257e9eaf.a9d202","name":"Check current door code","server":"5806b60f.c2e778","outputs":2,"halt_if":"payload","halt_if_type":"str","halt_if_compare":"is","override_topic":false,"entity_id":"input_text.enable_door","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":600,"y":674,"wires":[["217394d2.4a1e1c"],[]]},{"id":"4f40b870.148c48","type":"comment","z":"98bf1f56.6da51","name":"Outside front lights","info":"","x":105,"y":853,"wires":[]},{"id":"42844648.61be88","type":"traffic","z":"98bf1f56.6da51","name":"","property_allow":"topic","filter_allow":"mqtttimer/utility_light$","ignore_case_allow":false,"negate_allow":false,"send_allow":false,"property_stop":"topic","filter_stop":"mqtttimer/utility_light/start","ignore_case_stop":false,"negate_stop":false,"send_stop":false,"default_start":false,"differ":false,"x":1044.5,"y":728,"wires":[["32f6b23a.3b6fde"]]},{"id":"17e814bd.b9f32b","type":"inject","z":"98bf1f56.6da51","name":"every 1.5 minutes","topic":"","payload":"","payloadType":"date","repeat":"90","crontab":"","once":false,"onceDelay":0.1,"x":839.5,"y":728,"wires":[["42844648.61be88"]]},{"id":"edd43eff.7dce8","type":"switch","z":"98bf1f56.6da51","name":"off?","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"off","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":962.5,"y":530,"wires":[["d900bef7.910d7"]]},{"id":"70620d7c.3a2f54","type":"switch","z":"98bf1f56.6da51","name":"off?","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"off","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":882,"y":776,"wires":[["32f6b23a.3b6fde","42844648.61be88"]]},{"id":"8aa61cfb.3833a","type":"inject","z":"98bf1f56.6da51","name":"every 2.5 minutes","topic":"","payload":"","payloadType":"date","repeat":"150","crontab":"","once":false,"onceDelay":0.1,"x":128,"y":1001,"wires":[["84337193.ebef9"]]},{"id":"84337193.ebef9","type":"api-current-state","z":"98bf1f56.6da51","name":"sun?","server":"5806b60f.c2e778","outputs":2,"halt_if":"below_horizon","halt_if_type":"str","halt_if_compare":"is","override_topic":false,"entity_id":"sun.sun","state_type":"str","state_location":"","override_payload":"none","entity_location":"data","override_data":"msg","x":353,"y":975,"wires":[["e4568621.78c058"],["1177b894.f6a1e7"]]},{"id":"addab1e8.8ec15","type":"timecheck","z":"98bf1f56.6da51","name":"","time":"22:30","x":641.5,"y":1069,"wires":[["d8a88d08.cb456","7d0872bf.fa7b0c"],["583c0dea.db5804"]]},{"id":"a1e1aa5a.3c7b58","type":"timecheck","z":"98bf1f56.6da51","name":"","time":"09:00","x":642,"y":1027,"wires":[[],["d8a88d08.cb456"]]},{"id":"7d0872bf.fa7b0c","type":"api-call-service","z":"98bf1f56.6da51","name":"Dim sign light","server":"5806b60f.c2e778","service_domain":"light","service":"turn_on","data":"{\"entity_id\":\"light.sign\",\"brightness\":1,\"transition\":15}","mergecontext":"","output_location":"","output_location_type":"none","x":932,"y":1021,"wires":[[]]},{"id":"e21c93fe.7b26a","type":"switch","z":"98e70926.543948","name":"Topic filter","property":"topic","propertyType":"msg","rules":[{"t":"regex","v":"zigbee2mqtt/\\w+_motion(_\\d$)?","vt":"str","case":false},{"t":"regex","v":"zigbee2mqtt/\\w+_bulb(_\\d$)?","vt":"str","case":false}],"checkall":"false","repair":false,"outputs":2,"x":393,"y":537,"wires":[["2b20f320.21bdac"],["3cf13b27.85ea54"]],"outputLabels":["motion","bulb"]},{"id":"3cf13b27.85ea54","type":"switch","z":"98e70926.543948","name":"Has state?","property":"payload.state","propertyType":"msg","rules":[{"t":"nnull"}],"checkall":"true","repair":false,"outputs":1,"x":559.5,"y":562,"wires":[["a65980c9.66d2"]]},{"id":"a65980c9.66d2","type":"change","z":"98e70926.543948","name":"Set topic","rules":[{"t":"set","p":"topic","pt":"msg","to":"topic & '/ha_state'","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":727,"y":562,"wires":[["b0040182.93fae"]]},{"id":"6f9e63c2.ac625c","type":"debug","z":"257e9eaf.a9d202","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":665.5,"y":845,"wires":[]},{"id":"e6b6519f.8e3f5","type":"inject","z":"257e9eaf.a9d202","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":90.5,"y":848,"wires":[["d4b954c3.e26108"]]},{"id":"a491bece.76dba","type":"http request","z":"257e9eaf.a9d202","name":"login","method":"POST","ret":"obj","paytoqs":false,"url":"https://pickmypostcode.com/api/index.php/login/from/main","tls":"","proxy":"","authType":"basic","x":487.5,"y":841,"wires":[["6f9e63c2.ac625c"]]},{"id":"d4b954c3.e26108","type":"change","z":"257e9eaf.a9d202","name":"Set headers & body","rules":[{"t":"set","p":"payload","pt":"msg","to":"email=bradley.hopkinson%40live.com&postcode=cv35%200pg","tot":"str"},{"t":"set","p":"headers","pt":"msg","to":"{\"host\":\"pickmypostcode.com\",\"connection\":\"keep-alive\",\"accept\":\"application/json, text/javascript, */*; q=0.01\",\"origin\":\"https://pickmypostcode.com\",\"x-requested-with\":\"XMLHttpRequest\",\"user-agent\":\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/74.0.3729.169 Safari/537.36\",\"content-type\":\"application/x-www-form-urlencoded; charset=UTF-8\",\"referer\":\"https://pickmypostcode.com/\",\"accept-encoding\":\"gzip, deflate, br\",\"accept-language\":\"en-GB,en-US;q=0.9,en;q=0.8\"}","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":266.5,"y":848,"wires":[["a491bece.76dba"]]},{"id":"7f7529a6.12cf18","type":"inject","z":"98bf1f56.6da51","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":312.5,"y":683,"wires":[["f30bc5e2.0b0508"]]},{"id":"10d93d0e.21a2b3","type":"switch","z":"2837753f.46f60a","name":"Direction","property":"payload.direction","propertyType":"msg","rules":[{"t":"eq","v":"gate>door","vt":"str"}],"checkall":"false","repair":false,"outputs":1,"x":203,"y":217,"wires":[["1f0b2667.4329aa"]],"outputLabels":["on:gate>door"]},{"id":"1f0b2667.4329aa","type":"api-call-service","z":"2837753f.46f60a","name":"Canopy bulb 3","server":"5806b60f.c2e778","service_domain":"light","service":"","data":"{\"entity_id\":\"light.canopy_bulb_3\",\"brightness\":255,\"transition\":2}","mergecontext":"","output_location":"","output_location_type":"none","x":406.5,"y":217,"wires":[["75a0ecac.157f14"]]},{"id":"97529dbc.98d96","type":"api-call-service","z":"2837753f.46f60a","name":"Canopy bulb 2","server":"5806b60f.c2e778","service_domain":"light","service":"","data":"{\"entity_id\":\"light.canopy_bulb_2\",\"brightness\":255,\"transition\":2}","mergecontext":"","output_location":"","output_location_type":"none","x":812.5,"y":217,"wires":[["21987578.88d2ba"]]},{"id":"2f41a89a.ac8d08","type":"api-call-service","z":"2837753f.46f60a","name":"Canopy bulb 1","server":"5806b60f.c2e778","service_domain":"light","service":"","data":"{\"entity_id\":\"light.canopy_bulb_1\",\"brightness\":255,\"transition\":2}","mergecontext":"","output_location":"","output_location_type":"none","x":1218.5,"y":217,"wires":[[]]},{"id":"75a0ecac.157f14","type":"delay","z":"2837753f.46f60a","name":"","pauseType":"delay","timeout":"250","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":608,"y":217,"wires":[["97529dbc.98d96"]]},{"id":"21987578.88d2ba","type":"delay","z":"2837753f.46f60a","name":"","pauseType":"delay","timeout":"250","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":1016.5,"y":217,"wires":[["2f41a89a.ac8d08"]]},{"id":"b287f27b.ff7fd","type":"inject","z":"98bf1f56.6da51","name":"","topic":"","payload":"{\"direction\":\"gate>door\",\"service\":\"turn_on\"}","payloadType":"json","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":249.5,"y":1370,"wires":[["902c90c2.c56f2"]]},{"id":"902c90c2.c56f2","type":"subflow:2837753f.46f60a","z":"98bf1f56.6da51","name":"","x":457.5,"y":1369,"wires":[[]]},{"id":"807f741c.5d0c18","type":"debug","z":"98bf1f56.6da51","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":357.5,"y":1261,"wires":[]},{"id":"21cc061e.995d0a","type":"server-state-changed","z":"98bf1f56.6da51","name":"Canopy motion trigger","server":"5806b60f.c2e778","entityidfilter":"binary_sensor.canopy_motion_occupancy","entityidfiltertype":"exact","outputinitially":false,"state_type":"habool","haltifstate":"false","halt_if_type":"bool","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"x":117,"y":952,"wires":[["84337193.ebef9"],[]]},{"id":"1177b894.f6a1e7","type":"switch","z":"98bf1f56.6da51","name":"Motion triggered? N/Y","property":"topic","propertyType":"msg","rules":[{"t":"neq","v":"binary_sensor.canopy_motion_occupancy","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":391.5,"y":1094,"wires":[["addab1e8.8ec15","a1e1aa5a.3c7b58"],["7d2e5a9d.a5cdf4","a71f5c91.d8d49"]],"outputLabels":["no","yes"]},{"id":"7d2e5a9d.a5cdf4","type":"change","z":"98bf1f56.6da51","name":"set payload to turn_on","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\"direction\":\"gate>door\",\"service\":\"turn_on\"}","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":653.5,"y":1154,"wires":[["29935eda.82eba2"]]},{"id":"29935eda.82eba2","type":"subflow:2837753f.46f60a","z":"98bf1f56.6da51","name":"Turn on outside lights","env":[],"x":893.5,"y":1154,"wires":[[]]},{"id":"a71f5c91.d8d49","type":"change","z":"98bf1f56.6da51","name":"outside_lights timer: 2.5min","rules":[{"t":"set","p":"payload","pt":"msg","to":"150","tot":"json"},{"t":"set","p":"topic","pt":"msg","to":"mqtttimer/outside_lights/start","tot":"str"},{"t":"set","p":"responsePayload","pt":"msg","to":"off","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":673,"y":1114,"wires":[["ab2a9add.bf9df8","d8a88d08.cb456"]]},{"id":"ab2a9add.bf9df8","type":"subflow:94dca4da.a92a08","z":"98bf1f56.6da51","name":"Start timer","env":[],"x":923,"y":1114,"wires":[]},{"id":"d8a88d08.cb456","type":"traffic","z":"98bf1f56.6da51","name":"","property_allow":"topic","filter_allow":"mqtttimer/outside_lights$","ignore_case_allow":false,"negate_allow":false,"send_allow":false,"property_stop":"topic","filter_stop":"mqtttimer/outside_lights/start","ignore_case_stop":false,"negate_stop":false,"send_stop":false,"default_start":false,"differ":false,"x":922,"y":969,"wires":[["986e3476.9915c8"]]},{"id":"a4247b76.c07758","type":"mqtt in","z":"98bf1f56.6da51","name":"","topic":"mqtttimer/outside_lights","qos":"1","datatype":"auto","broker":"ab404be4.584f18","x":575,"y":918,"wires":[["34c2eb2c.0d0194"]]},{"id":"34c2eb2c.0d0194","type":"switch","z":"98bf1f56.6da51","name":"off?","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"off","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":745.5,"y":918,"wires":[["d8a88d08.cb456","ba6ebad1.dedfb8"]]},{"id":"ba6ebad1.dedfb8","type":"timecheck","z":"98bf1f56.6da51","name":"","time":"22:30","x":923,"y":918,"wires":[["986e3476.9915c8"],["8e327eca.45a9b"]]},{"id":"c62aedef.d95f3","type":"api-call-service","z":"98bf1f56.6da51","name":"Turn on sign light","server":"5806b60f.c2e778","service_domain":"light","service":"turn_on","data":"{\"entity_id\":\"light.sign\",\"brightness_pct\":75,\"transition\":15}","mergecontext":"","output_location":"","output_location_type":"none","x":1150,"y":1068,"wires":[["8e327eca.45a9b"]]},{"id":"c6e96190.a3277","type":"server-state-changed","z":"98bf1f56.6da51","name":"Sun","server":"5806b60f.c2e778","entityidfilter":"sun.sun","entityidfiltertype":"exact","outputinitially":true,"state_type":"str","haltifstate":"","halt_if_type":"str","halt_if_compare":"is","outputs":1,"output_only_on_state_change":true,"x":164,"y":905,"wires":[["84337193.ebef9"]]},{"id":"f44e984d.7457b8","type":"link out","z":"9943920f.042cc","name":"Recieved PickMyPostcode draw alert email","links":["8369ca3.2be1f38"],"x":571,"y":143,"wires":[]},{"id":"f7092721.910408","type":"comment","z":"257e9eaf.a9d202","name":"PickMyPostcode","info":"","x":91,"y":908,"wires":[]},{"id":"8369ca3.2be1f38","type":"link in","z":"257e9eaf.a9d202","name":"Process PickMyPostcode draw alert email","links":["f44e984d.7457b8"],"x":47,"y":956,"wires":[["c0ef17c3.57dc98"]]},{"id":"4614997d.f3b4b8","type":"debug","z":"257e9eaf.a9d202","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":508.5,"y":914,"wires":[]},{"id":"c0ef17c3.57dc98","type":"change","z":"257e9eaf.a9d202","name":"Extract login url","rules":[{"t":"set","p":"loginurl","pt":"msg","to":"$match(payload, /https:\\/\\/\\S+login\\S+\\b/).match","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":187.5,"y":956,"wires":[["d0088782.d74858"]]},{"id":"d0088782.d74858","type":"switch","z":"257e9eaf.a9d202","name":"Not null?","property":"loginurl","propertyType":"msg","rules":[{"t":"nnull"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":369.5,"y":956,"wires":[["4614997d.f3b4b8"],[]]},{"id":"583c0dea.db5804","type":"timecheck","z":"98bf1f56.6da51","name":"","time":"09:00","x":942,"y":1075,"wires":[["c62aedef.d95f3"],[]]}]